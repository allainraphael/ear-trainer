<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ear Training Tool</title>
<style>
body { font-family: Arial, sans-serif; background:#222; color:#fff; text-align:center; padding:20px; }
#spectrumContainer { position: relative; width: 100%; max-width:900px; height:300px; margin: auto; background:#000; border-radius:10px; }
canvas { width:100%; height:100%; display:block; border-radius:10px; }
#bandButtonsContainer { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; }
.freq-band-btn { position:absolute; top:0; height:100%; pointer-events:auto; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:0.8em; transition: background 0.3s; }
.freq-band-btn.active { background: rgba(255,255,255,0.4); color:#000; font-weight:bold; }
.controls { margin-top:10px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap; }
.controls button { padding:10px 20px; border:none; border-radius:5px; background:linear-gradient(45deg,#4facfe,#00f2fe); color:#fff; cursor:pointer; font-size:1em; }
.controls button.active { background:linear-gradient(45deg,#ff6b6b,#ffd93d); color:#000; }
#fileInput { margin-bottom:10px; }
#volumeControl { margin-top:10px; }
</style>
</head>
<body>

<h1>Ear Training Tool</h1>
<input type="file" id="fileInput" accept="audio/*">
<div id="spectrumContainer">
    <canvas id="spectrum"></canvas>
    <div id="bandButtonsContainer"></div>
</div>

<div class="controls">
    <button id="playBtn">‚ñ∂Ô∏è Lecture</button>
    <button id="pauseBtn">‚è∏Ô∏è Pause</button>
    <button id="stopBtn">‚èπÔ∏è Stop</button>
    <button id="loopBtn">üîÑ Boucle</button>
</div>

<div id="volumeControl">
    üîä Volume: <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.7">
    <span id="volumeValue">70%</span>
</div>

<script>
class EarTrainingTool {
    constructor() {
        this.audioContext = null;
        this.audioBuffer = null;
        this.source = null;
        this.gainNode = null;
        this.analyser = null;
        this.isPlaying = false;
        this.isLooping = false;
        this.currentBand = null;

        this.canvas = document.getElementById('spectrum');
        this.ctx = this.canvas.getContext('2d');

        this.bands = {
            'Sub-Bass': { low: 20, high: 60, color:'rgba(255,0,0,0.2)' },
            'Bass': { low: 60, high: 250, color:'rgba(255,165,0,0.2)' },
            'Low-Mid': { low: 250, high: 500, color:'rgba(255,255,0,0.2)' },
            'Mid': { low: 500, high: 2000, color:'rgba(0,255,0,0.2)' },
            'High-Mid': { low: 2000, high: 4000, color:'rgba(0,255,255,0.2)' },
            'Treble': { low: 4000, high: 8000, color:'rgba(0,0,255,0.2)' },
            'High-Treble': { low: 8000, high: 20000, color:'rgba(128,0,255,0.2)' }
        };

        this.setupCanvas();
        this.addEventListeners();
    }

    setupCanvas() {
        this.canvas.width = this.canvas.offsetWidth * window.devicePixelRatio;
        this.canvas.height = this.canvas.offsetHeight * window.devicePixelRatio;
        this.ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
    }

    addEventListeners() {
        document.getElementById('fileInput').addEventListener('change', e => this.loadFile(e));
        document.getElementById('playBtn').addEventListener('click', () => this.play());
        document.getElementById('pauseBtn').addEventListener('click', () => this.pause());
        document.getElementById('stopBtn').addEventListener('click', () => this.stop());
        document.getElementById('loopBtn').addEventListener('click', () => this.toggleLoop());
        document.getElementById('volumeSlider').addEventListener('input', e => this.setVolume(e.target.value));

        window.addEventListener('resize', () => this.setupCanvas());
    }

    async loadFile(event) {
        const file = event.target.files[0];
        if(!file) return;
        try {
            if(!this.audioContext) this.audioContext = new (window.AudioContext||window.webkitAudioContext)();
            const arrayBuffer = await file.arrayBuffer();
            this.audioBuffer = await this.audioContext.decodeAudioData(arrayBuffer);
            this.setupAnalyser();
            this.createBandButtons();
        } catch(e) { alert('Erreur audio'); console.error(e); }
    }

    setupAnalyser() {
        this.analyser = this.audioContext.createAnalyser();
        this.analyser.fftSize = 2048;
        this.analyser.smoothingTimeConstant = 0.8;
    }

    play() {
        if(!this.audioBuffer) return;
        this.stop();

        this.source = this.audioContext.createBufferSource();
        this.source.buffer = this.audioBuffer;
        this.source.loop = this.isLooping;

        this.gainNode = this.audioContext.createGain();
        this.gainNode.gain.value = document.getElementById('volumeSlider').value;

        if(this.currentBand){
            const band = this.bands[this.currentBand];
            const highpass = this.audioContext.createBiquadFilter();
            highpass.type='highpass'; highpass.frequency.value = band.low;
            const lowpass = this.audioContext.createBiquadFilter();
            lowpass.type='lowpass'; lowpass.frequency.value = band.high;
            this.source.connect(highpass); highpass.connect(lowpass); lowpass.connect(this.gainNode);
        } else {
            this.source.connect(this.gainNode);
        }

        this.gainNode.connect(this.analyser);
        this.analyser.connect(this.audioContext.destination);
        this.source.start();
        this.isPlaying = true;
        this.visualize();
    }

    pause(){ this.stop(); }
    stop(){ if(this.source){ this.source.stop(); this.source=null; this.isPlaying=false; } }
    toggleLoop(){
        this.isLooping = !this.isLooping;
        document.getElementById('loopBtn').classList.toggle('active', this.isLooping);
        if(this.source) this.source.loop = this.isLooping;
    }

    setVolume(val){ document.getElementById('volumeValue').textContent=Math.round(val*100)+'%'; if(this.gainNode)this.gainNode.gain.value=val; }

    createBandButtons(){
        const container = document.getElementById('bandButtonsContainer');
        container.innerHTML='';
        const width = container.offsetWidth;

        Object.keys(this.bands).forEach(name=>{
            const b = this.bands[name];
            const btn = document.createElement('div');
            btn.classList.add('freq-band-btn');
            const x1 = Math.log10(b.low/20)/Math.log10(20000/20)*width;
            const x2 = Math.log10(b.high/20)/Math.log10(20000/20)*width;
            btn.style.left = x1+'px';
            btn.style.width = (x2-x1)+'px';
            btn.style.background = b.color;
            btn.textContent = name;
            btn.addEventListener('click', ()=>{
                this.currentBand = this.currentBand===name?null:name;
                Array.from(container.children).forEach(c=>c.classList.remove('active'));
                if(this.currentBand) btn.classList.add('active');
                this.play();
            });
            container.appendChild(btn);
        });
    }

    visualize(){
        if(!this.analyser) return;
        const ctx=this.ctx,canvas=this.canvas;
        const width=canvas.offsetWidth, height=canvas.offsetHeight;
        const dataArray=new Uint8Array(this.analyser.frequencyBinCount);
        const draw=()=>{
            if(!this.isPlaying) return;
            requestAnimationFrame(draw);
            this.analyser.getByteFrequencyData(dataArray);
            ctx.fillStyle='#000';
            ctx.fillRect(0,0,width,height);

            // Dessiner spectre
            ctx.beginPath();
            ctx.strokeStyle='#0f0';
            ctx.lineWidth=2;
            const nyquist=this.audioContext.sampleRate/2;
            for(let i=0;i<dataArray.length;i++){
                const freq=(i*nyquist)/dataArray.length;
                if(freq<20||freq>20000) continue;
                const x=Math.log10(freq/20)/Math.log10(20000/20)*width;
                const y=height-(dataArray[i]/255)*height;
                if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
            }
            ctx.stroke();

            // Dessiner axes des fr√©quences
            ctx.fillStyle='#fff';
            ctx.font='10px Arial';
            [20,50,100,200,500,1000,2000,5000,10000,20000].forEach(f=>{
                const x=Math.log10(f/20)/Math.log10(20000/20)*width;
                const label=f>=1000?f/1000+'k':f;
                ctx.fillText(label,x,10);
            });
        };
        draw();
    }
}

const tool = new EarTrainingTool();
</script>

</body>
</html>
