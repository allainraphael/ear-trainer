<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Outil d'Ear Training - CNSMDP</title>
<style>
body {
    background: #fff;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #000;
    padding: 20px;
}

.container {
    max-width: 1000px;
    margin: 0 auto;
}

h1 {
    text-align: center;
    margin-bottom: 20px;
}

.upload-section {
    text-align: center;
    margin-bottom: 15px;
}

.file-input {
    display: none;
}

.file-label {
    display: inline-block;
    padding: 10px 20px;
    background: #4facfe;
    color: #fff;
    border-radius: 25px;
    cursor: pointer;
}

.controls {
    text-align: center;
    margin-top: 15px;
}

.control-btn {
    margin: 5px;
    padding: 8px 20px;
    border: none;
    border-radius: 25px;
    background: #667eea;
    color: white;
    cursor: pointer;
}

canvas {
    display: block;
    width: 100%;
    height: 400px;
    background: #000;
    margin: 0 auto;
    border-radius: 10px;
}
</style>
</head>
<body>
<div class="container">
    <h1>Outil d'Ear Training</h1>

    <div class="upload-section">
        <input type="file" id="audioFile" class="file-input" accept="audio/*">
        <label for="audioFile" class="file-label">üìÅ Charger un fichier audio</label>
    </div>

    <canvas id="spectrum"></canvas>

    <div class="controls">
        <button class="control-btn" id="playBtn">‚ñ∂Ô∏è Lecture</button>
        <button class="control-btn" id="pauseBtn">‚è∏Ô∏è Pause</button>
        <button class="control-btn" id="stopBtn">‚èπÔ∏è Stop</button>
        <button class="control-btn" id="loopBtn">üîÑ Boucle</button>
    </div>
</div>

<script>
class EarTrainingTool {
    constructor() {
        this.audioCtx = null;
        this.source = null;
        this.gainNode = null;
        this.analyser = null;
        this.audioBuffer = null;
        this.isPlaying = false;
        this.isLooping = false;
        this.currentBand = null;

        this.canvas = document.getElementById('spectrum');
        this.ctx = this.canvas.getContext('2d');

        this.bands = {
            'sub-bass': {low: 20, high: 60, color: 'rgba(255,0,0,0.3)', name: 'Sub-Bass'},
            'bass': {low: 60, high: 250, color: 'rgba(255,165,0,0.3)', name: 'Bass'},
            'low-mid': {low: 250, high: 500, color: 'rgba(255,255,0,0.3)', name: 'Low-Mid'},
            'mid': {low: 500, high: 2000, color: 'rgba(0,255,0,0.3)', name: 'Mid'},
            'high-mid': {low: 2000, high: 4000, color: 'rgba(0,255,255,0.3)', name: 'High-Mid'},
            'treble': {low: 4000, high: 8000, color: 'rgba(0,0,255,0.3)', name: 'Treble'},
            'high-treble': {low: 8000, high: 20000, color: 'rgba(128,0,255,0.3)', name: 'High-Treble'}
        };

        this.setupCanvas();
        this.initEvents();
        this.drawStatic();
    }

    setupCanvas() {
        const dpr = window.devicePixelRatio || 1;
        this.canvas.width = this.canvas.offsetWidth * dpr;
        this.canvas.height = this.canvas.offsetHeight * dpr;
        this.ctx.scale(dpr, dpr);
    }

    initEvents() {
        document.getElementById('audioFile').addEventListener('change', e => this.loadAudio(e));
        document.getElementById('playBtn').addEventListener('click', () => this.play());
        document.getElementById('pauseBtn').addEventListener('click', () => this.pause());
        document.getElementById('stopBtn').addEventListener('click', () => this.stop());
        document.getElementById('loopBtn').addEventListener('click', () => this.toggleLoop());
        this.canvas.addEventListener('click', e => this.handleCanvasClick(e));
    }

    async loadAudio(event) {
        const file = event.target.files[0];
        if (!file) return;
        this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const arrayBuffer = await file.arrayBuffer();
        this.audioBuffer = await this.audioCtx.decodeAudioData(arrayBuffer);

        this.analyser = this.audioCtx.createAnalyser();
        this.analyser.fftSize = 2048;

        this.gainNode = this.audioCtx.createGain();
        this.gainNode.gain.value = 0.7;

        this.animate();
    }

    play() {
        if (!this.audioBuffer) return;
        this.stop();
        this.source = this.audioCtx.createBufferSource();
        this.source.buffer = this.audioBuffer;
        this.source.loop = this.isLooping;

        let outputNode = this.gainNode;

        if (this.currentBand) {
            const band = this.bands[this.currentBand];
            const hp = this.audioCtx.createBiquadFilter();
            hp.type = 'highpass';
            hp.frequency.value = band.low;
            const lp = this.audioCtx.createBiquadFilter();
            lp.type = 'lowpass';
            lp.frequency.value = band.high;
            hp.connect(lp);
            lp.connect(this.gainNode);
            outputNode = hp;
        }

        this.source.connect(outputNode);
        this.gainNode.connect(this.analyser);
        this.analyser.connect(this.audioCtx.destination);
        this.source.start();
        this.isPlaying = true;
    }

    pause() { this.stop(); }

    stop() {
        if (this.source) { this.source.stop(); this.source = null; this.isPlaying = false; }
    }

    toggleLoop() {
        this.isLooping = !this.isLooping;
        document.getElementById('loopBtn').style.background = this.isLooping ? '#ffa500' : '#667eea';
        if (this.source) this.source.loop = this.isLooping;
    }

    handleCanvasClick(e) {
        const rect = this.canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const width = this.canvas.offsetWidth;
        const logX = x / width;
        const freq = Math.pow(10, Math.log10(20) + logX * (Math.log10(20000) - Math.log10(20)));

        for (const key in this.bands) {
            const b = this.bands[key];
            if (freq >= b.low && freq <= b.high) {
                this.currentBand = (this.currentBand === key) ? null : key;
                break;
            }
        }
    }

    drawStatic() {
        const ctx = this.ctx;
        const width = this.canvas.offsetWidth;
        const height = this.canvas.offsetHeight;
        ctx.clearRect(0, 0, width, height);
        // Dessin des bandes
        for (const key in this.bands) {
            const band = this.bands[key];
            const x1 = this.freqToX(band.low, width);
            const x2 = this.freqToX(band.high, width);
            ctx.fillStyle = (this.currentBand === key) ? band.color.replace('0.3','0.6') : band.color;
            ctx.fillRect(x1, 0, x2-x1, height);
            if (this.currentBand === key) {
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`${band.name}\n${band.low}-${band.high} Hz`, (x1+x2)/2, 20);
            }
        }
    }

    freqToX(f, width) {
        return ((Math.log10(f)-Math.log10(20))/(Math.log10(20000)-Math.log10(20)))*width;
    }

    animate() {
        if (!this.analyser) return;
        const ctx = this.ctx;
        const width = this.canvas.offsetWidth;
        const height = this.canvas.offsetHeight;
        const bufferLength = this.analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        this.analyser.getByteFrequencyData(dataArray);

        ctx.clearRect(0, 0, width, height);

        // Dessiner les bandes
        for (const key in this.bands) {
            const band = this.bands[key];
            const x1 = this.freqToX(band.low, width);
            const x2 = this.freqToX(band.high, width);
            ctx.fillStyle = (this.currentBand === key) ? band.color.replace('0.3','0.6') : band.color;
            ctx.fillRect(x1, 0, x2-x1, height);
            if (this.currentBand === key) {
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`${band.name} - ${band.low}-${band.high} Hz`, (x1+x2)/2, 20);
            }
        }

        // Dessiner le spectre
        ctx.beginPath();
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        const nyquist = this.audioCtx.sampleRate/2;
        for (let i=0;i<bufferLength;i++) {
            const freq = (i*nyquist)/bufferLength;
            if(freq<20||freq>20000) continue;
            const x = this.freqToX(freq,width);
            const y = height - (dataArray[i]/255*height);
            if(i===0) ctx.moveTo(x,y);
            else ctx.lineTo(x,y);
        }
        ctx.stroke();

        requestAnimationFrame(()=>this.animate());
    }
}

window.addEventListener('load',()=>new EarTrainingTool());
window.addEventListener('resize',()=>{
    const tool = new EarTrainingTool();
    tool.setupCanvas();
});
</script>
</body>
</html>
