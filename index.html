<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Outil d'Ear Training - CNSMDP</title>
<style>
    body {
        background: #fff;
        font-family: Arial, sans-serif;
        color: #000;
        text-align: center;
        padding: 20px;
    }
    h1 { margin-bottom: 20px; }
    #audioFile, #playBtn, #pauseBtn, #stopBtn, #loopBtn, #volumeSlider {
        margin: 5px;
    }
    canvas { 
        display: block; 
        margin: 20px auto; 
        background: #000; 
        border:1px solid #ccc;
    }
</style>
</head>
<body>
<h1>Outil d'Ear Training</h1>

<input type="file" id="audioFile" accept="audio/*"><br>
<button id="playBtn">‚ñ∂Ô∏è Lecture</button>
<button id="pauseBtn">‚è∏Ô∏è Pause</button>
<button id="stopBtn">‚èπÔ∏è Stop</button>
<button id="loopBtn">üîÑ Boucle</button><br>
Volume: <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.7"><br>

<canvas id="spectrum" width="1000" height="400"></canvas>

<script>
class EarTrainingTool {
    constructor() {
        this.audioCtx = null;
        this.audioBuffer = null;
        this.source = null;
        this.gainNode = null;
        this.analyser = null;
        this.isPlaying = false;
        this.isLooping = false;
        this.currentBand = null;

        this.canvas = document.getElementById('spectrum');
        this.ctx = this.canvas.getContext('2d');

        this.bands = [
            {name:'Sub-Bass', low:20, high:60, color:'rgba(255,0,0,0.3)'},
            {name:'Bass', low:60, high:250, color:'rgba(255,165,0,0.3)'},
            {name:'Low-Mid', low:250, high:500, color:'rgba(255,255,0,0.3)'},
            {name:'Mid', low:500, high:2000, color:'rgba(0,255,0,0.3)'},
            {name:'High-Mid', low:2000, high:4000, color:'rgba(0,255,255,0.3)'},
            {name:'Treble', low:4000, high:8000, color:'rgba(0,0,255,0.3)'},
            {name:'High-Treble', low:8000, high:20000, color:'rgba(128,0,128,0.3)'}
        ];

        this.init();
    }

    init() {
        document.getElementById('audioFile').addEventListener('change', e=>this.loadAudio(e));
        document.getElementById('playBtn').addEventListener('click', ()=>this.play());
        document.getElementById('pauseBtn').addEventListener('click', ()=>this.pause());
        document.getElementById('stopBtn').addEventListener('click', ()=>this.stop());
        document.getElementById('loopBtn').addEventListener('click', ()=>this.toggleLoop());
        document.getElementById('volumeSlider').addEventListener('input', e=>{
            if(this.gainNode) this.gainNode.gain.value = e.target.value;
        });

        this.canvas.addEventListener('click', e=>this.handleCanvasClick(e));

        requestAnimationFrame(()=>this.draw());
    }

    async loadAudio(event){
        const file = event.target.files[0];
        if(!file) return;
        if(!this.audioCtx) this.audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        const arrayBuffer = await file.arrayBuffer();
        this.audioBuffer = await this.audioCtx.decodeAudioData(arrayBuffer);

        this.analyser = this.audioCtx.createAnalyser();
        this.analyser.fftSize = 2048;

        this.gainNode = this.audioCtx.createGain();
        this.gainNode.gain.value = document.getElementById('volumeSlider').value;
    }

    play(){
        if(!this.audioBuffer) return;
        this.stop();
        this.source = this.audioCtx.createBufferSource();
        this.source.buffer = this.audioBuffer;
        this.source.loop = this.isLooping;

        let inputNode = this.source;
        if(this.currentBand){
            // filtre bande passante
            const band = this.currentBand;
            const highpass = this.audioCtx.createBiquadFilter();
            highpass.type = 'highpass';
            highpass.frequency.value = band.low;
            highpass.Q.value = 1;
            const lowpass = this.audioCtx.createBiquadFilter();
            lowpass.type = 'lowpass';
            lowpass.frequency.value = band.high;
            lowpass.Q.value = 1;
            inputNode.connect(highpass);
            highpass.connect(lowpass);
            lowpass.connect(this.gainNode);
        } else {
            inputNode.connect(this.gainNode);
        }

        this.gainNode.connect(this.analyser);
        this.analyser.connect(this.audioCtx.destination);
        this.source.start(0);
        this.isPlaying = true;
    }

    pause(){
        if(this.source && this.isPlaying){
            this.source.stop();
            this.isPlaying=false;
        }
    }

    stop(){
        if(this.source){
            this.source.stop();
            this.source=null;
            this.isPlaying=false;
        }
    }

    toggleLoop(){
        this.isLooping=!this.isLooping;
        if(this.source) this.source.loop=this.isLooping;
    }

    handleCanvasClick(e){
        const rect = this.canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const width = this.canvas.width;
        const logMin = Math.log10(20);
        const logMax = Math.log10(20000);
        const freq = Math.pow(10, logMin + (x/width)*(logMax-logMin));

        for(let b of this.bands){
            if(freq>=b.low && freq<=b.high){
                this.currentBand = b;
                if(this.isPlaying) this.play(); // r√©appliquer filtre
                break;
            }
        }
    }

    frequencyToX(freq){
        const width = this.canvas.width;
        const logMin = Math.log10(20);
        const logMax = Math.log10(20000);
        const logF = Math.log10(freq);
        return ((logF-logMin)/(logMax-logMin))*width;
    }

    draw(){
        const ctx = this.ctx;
        const w = this.canvas.width;
        const h = this.canvas.height;

        // fond
        ctx.fillStyle = '#000';
        ctx.fillRect(0,0,w,h);

        // dessiner bandes
        this.bands.forEach(b=>{
            const x1=this.frequencyToX(b.low);
            const x2=this.frequencyToX(b.high);
            ctx.fillStyle=(this.currentBand===b)?b.color.replace(/0\.3/,'0.8'):b.color;
            ctx.fillRect(x1,0,x2-x1,h);

            if(this.currentBand===b){
                ctx.fillStyle='white';
                ctx.font='14px Arial';
                ctx.textAlign='center';
                ctx.fillText(b.name,(x1+x2)/2,h/2-8);
                ctx.fillText(`${b.low}-${b.high} Hz`,(x1+x2)/2,h/2+10);
            }
        });

        // spectre si audio
        if(this.analyser){
            const bufferLength = this.analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            this.analyser.getByteFrequencyData(dataArray);
            ctx.beginPath();
            ctx.strokeStyle='#0f0';
            ctx.lineWidth=2;
            for(let i=0;i<bufferLength;i++){
                const nyquist=this.audioCtx.sampleRate/2;
                const freq = (i*nyquist)/bufferLength;
                if(freq<20||freq>20000) continue;
                const x = this.frequencyToX(freq);
                const amplitude = dataArray[i];
                const y = h - (amplitude/255)*h;
                if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
            }
            ctx.stroke();
        }

        requestAnimationFrame(()=>this.draw());
    }
}

new EarTrainingTool();
</script>
</body>
</html>
