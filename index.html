<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Outil d'Ear Training - CNSMDP</title>
<style>
body { font-family: sans-serif; background: #fff; color: #000; padding:20px; }
.container { max-width:900px; margin:0 auto; }
h1 { text-align:center; }
.upload-section, .controls, .volume-control { text-align:center; margin-bottom:20px; }
.file-input { display:none; }
.file-label { display:inline-block; padding:10px 20px; background:#667eea; color:#fff; border-radius:8px; cursor:pointer; }
.control-btn { padding:8px 15px; margin:0 5px; border:none; border-radius:5px; background:#667eea; color:#fff; cursor:pointer; }
.control-btn.active { background:#ffa500; }
#spectrumContainer { position:relative; width:100%; height:300px; background:#000; border-radius:10px; margin-bottom:10px; }
#spectrum { width:100%; height:100%; display:block; }
</style>
</head>
<body>
<div class="container">
<h1>Outil d'Ear Training</h1>

<div class="upload-section">
<input type="file" id="audioFile" class="file-input" accept="audio/*">
<label for="audioFile" class="file-label">üìÅ Parcourir un fichier audio</label>
</div>

<div id="spectrumContainer">
<canvas id="spectrum"></canvas>
</div>

<div class="controls">
<button class="control-btn" id="playBtn">‚ñ∂Ô∏è Lecture</button>
<button class="control-btn" id="stopBtn">‚èπÔ∏è Stop</button>
<button class="control-btn" id="loopBtn">üîÑ Boucle</button>
</div>

<script>
class EarTrainingTool {
    constructor() {
        this.audioCtx = null;
        this.audioBuffer = null;
        this.source = null;
        this.gainNode = null;
        this.analyser = null;
        this.isPlaying = false;
        this.isLooping = true; // boucle activ√©e par d√©faut
        this.currentBand = null;

        this.canvas = document.getElementById('spectrum');
        this.ctx = this.canvas.getContext('2d');

        this.frequencyBands = {
            'sub-bass': { low: 20, high: 60, name:'Sub-Bass', color:'#ff4d4d' },
            'bass': { low: 60, high: 250, name:'Bass', color:'#ff944d' },
            'low-mid': { low: 250, high: 500, name:'Low-Mid', color:'#ffff4d' },
            'mid': { low: 500, high: 2000, name:'Mid', color:'#4dff4d' },
            'high-mid': { low: 2000, high: 4000, name:'High-Mid', color:'#4dffff' },
            'treble': { low: 4000, high: 8000, name:'Treble', color:'#4d4dff' },
            'high-treble': { low: 8000, high: 20000, name:'High-Treble', color:'#b84dff' }
        };

        this.setupCanvas();
        this.initializeEventListeners();
        this.startVisualization();
    }

    setupCanvas() {
        const canvas = this.canvas;
        canvas.width = canvas.offsetWidth * window.devicePixelRatio;
        canvas.height = canvas.offsetHeight * window.devicePixelRatio;
        this.ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

        canvas.addEventListener('click', (e) => this.handleCanvasClick(e));
    }

    initializeEventListeners() {
        document.getElementById('audioFile').addEventListener('change', (e) => this.loadAudioFile(e));
        document.getElementById('playBtn').addEventListener('click', () => this.play());
        document.getElementById('stopBtn').addEventListener('click', () => this.stop());
        document.getElementById('loopBtn').addEventListener('click', () => this.toggleLoop());
        window.addEventListener('resize', () => this.setupCanvas());
    }

    async loadAudioFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        try {
            this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const arrayBuffer = await file.arrayBuffer();
            this.audioBuffer = await this.audioCtx.decodeAudioData(arrayBuffer);

            this.analyser = this.audioCtx.createAnalyser();
            this.analyser.fftSize = 2048;
        } catch(err) {
            alert('Erreur chargement fichier audio');
        }
    }

    play() {
        if (!this.audioBuffer) return;
        this.stop();
        this.source = this.audioCtx.createBufferSource();
        this.source.buffer = this.audioBuffer;
        this.source.loop = this.isLooping;

        this.gainNode = this.audioCtx.createGain();
        this.gainNode.gain.value = 0.7;

        if(this.currentBand) {
            const band = this.frequencyBands[this.currentBand];
            this.filterNode = this.createBandpassFilter(band.low, band.high);
            this.source.connect(this.filterNode.input);
            this.filterNode.output.connect(this.gainNode);
        } else {
            this.source.connect(this.gainNode);
        }

        this.gainNode.connect(this.analyser);
        this.analyser.connect(this.audioCtx.destination);
        this.source.start();
        this.isPlaying = true;
    }

    stop() {
        if(this.source) {
            this.source.stop();
            this.source = null;
            this.isPlaying = false;
        }
    }

    toggleLoop() {
        this.isLooping = !this.isLooping;
        const btn = document.getElementById('loopBtn');
        btn.classList.toggle('active', this.isLooping);
        if(this.source) this.source.loop = this.isLooping;
    }

    createBandpassFilter(low, high) {
        const hp = this.audioCtx.createBiquadFilter();
        hp.type = 'highpass'; hp.frequency.value = low; hp.Q.value=1;
        const lp = this.audioCtx.createBiquadFilter();
        lp.type='lowpass'; lp.frequency.value=high; lp.Q.value=1;
        hp.connect(lp);
        return { input: hp, output: lp };
    }

    handleCanvasClick(event) {
        const rect = this.canvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const width = this.canvas.offsetWidth;
        const minLog = Math.log10(20), maxLog = Math.log10(20000);
        const freq = Math.pow(10, minLog + (x/width)*(maxLog-minLog));
        let clicked = null;
        for(let key in this.frequencyBands) {
            const b = this.frequencyBands[key];
            if(freq>=b.low && freq<=b.high) clicked = key;
        }
        if(clicked) this.currentBand = clicked;
    }

    startVisualization() {
        const draw = () => {
            const ctx = this.ctx, w=this.canvas.offsetWidth, h=this.canvas.offsetHeight;
            ctx.fillStyle = '#000'; ctx.fillRect(0,0,w,h);

            // bandes
            for(let key in this.frequencyBands){
                const b=this.frequencyBands[key];
                const x1=this.freqToX(b.low,w), x2=this.freqToX(b.high,w);
                ctx.fillStyle = b.color; ctx.globalAlpha = (this.currentBand===key?0.7:0.3);
                ctx.fillRect(x1,0,x2-x1,h);
            }
            ctx.globalAlpha=1;

            if(this.analyser){
                const bufferLength = this.analyser.frequencyBinCount;
                const data = new Uint8Array(bufferLength);
                this.analyser.getByteFrequencyData(data);
                ctx.beginPath(); ctx.strokeStyle='#fff'; ctx.lineWidth=2;
                const nyq = this.audioCtx.sampleRate/2;
                for(let i=0;i<bufferLength;i++){
                    const freq = i*nyq/bufferLength;
                    if(freq<20||freq>20000) continue;
                    const x = this.freqToX(freq,w);
                    const y = h - (data[i]/255)*h;
                    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
                }
                ctx.stroke();
            }

            // afficher nom et plage si bande s√©lectionn√©e
            if(this.currentBand){
                const b = this.frequencyBands[this.currentBand];
                ctx.fillStyle='#fff'; ctx.font='14px Arial'; ctx.textAlign='center';
                const x1=this.freqToX(b.low,w), x2=this.freqToX(b.high,w), cx=(x1+x2)/2;
                ctx.fillText(`${b.name}\n${b.low}-${b.high>=1000?b.high/1000+'k':b.high}Hz`, cx, 20);
            }

            requestAnimationFrame(draw);
        };
        draw();
    }

    freqToX(freq,width){
        const minLog = Math.log10(20), maxLog = Math.log10(20000);
        return (Math.log10(freq)-minLog)/(maxLog-minLog)*width;
    }
}

// Initialisation
window.addEventListener('load',()=>{ new EarTrainingTool(); });
</script>
</body>
</html>
