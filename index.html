<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Ear Training Avanc√©</title>
  <style>
    body {
      font-family: sans-serif;
      background: #1e3c72;
      color: white;
      text-align: center;
      padding: 20px;
    }
    #spectrum {
      width: 100%;
      height: 300px;
      background: black;
      margin-top: 20px;
      border-radius: 10px;
    }
    .controls, .bands {
      margin: 20px;
    }
    button {
      padding: 8px 15px;
      margin: 5px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background: #3b82f6;
      color: white;
    }
    button.active {
      background: #f97316;
    }
    input[type=range] {
      width: 200px;
    }
  </style>
</head>
<body>
  <h1>Outil d'Ear Training (avec filtres)</h1>
  <input type="file" id="fileInput" accept="audio/*">
  <p id="fileInfo">Aucun fichier charg√©</p>

  <div class="controls">
    <button id="playBtn">‚ñ∂Ô∏è Lecture</button>
    <button id="pauseBtn">‚è∏Ô∏è Pause</button>
    <button id="stopBtn">‚èπÔ∏è Stop</button>
    <button id="loopBtn">üîÅ Boucle OFF</button>
    <br><br>
    üîä Volume :
    <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.7">
  </div>

  <div class="bands">
    <h3>Bandes de fr√©quences</h3>
    <div id="bandButtons"></div>
  </div>

  <canvas id="spectrum"></canvas>

  <script>
    class EarTrainer {
      constructor() {
        this.audioContext = null;
        this.audioBuffer = null;
        this.source = null;
        this.gainNode = null;
        this.analyser = null;
        this.filterNode = null;
        this.isPlaying = false;
        this.isLooping = false;
        this.startedAt = 0;
        this.pausedAt = 0;
        this.currentBand = null;

        this.canvas = document.getElementById("spectrum");
        this.ctx = this.canvas.getContext("2d");

        // D√©finition des bandes
        this.bands = [
          { name: "Sub-Bass", low: 20, high: 60 },
          { name: "Bass", low: 60, high: 250 },
          { name: "Low-Mid", low: 250, high: 500 },
          { name: "Mid", low: 500, high: 2000 },
          { name: "High-Mid", low: 2000, high: 4000 },
          { name: "Treble", low: 4000, high: 8000 },
          { name: "High-Treble", low: 8000, high: 20000 }
        ];

        this.setupEvents();
        this.createBandButtons();
        this.resizeCanvas();
        window.addEventListener("resize", () => this.resizeCanvas());
      }

      setupEvents() {
        document.getElementById("fileInput").addEventListener("change", e => this.loadFile(e));
        document.getElementById("playBtn").addEventListener("click", () => this.play());
        document.getElementById("pauseBtn").addEventListener("click", () => this.pause());
        document.getElementById("stopBtn").addEventListener("click", () => this.stop());
        document.getElementById("loopBtn").addEventListener("click", () => this.toggleLoop());
        document.getElementById("volumeSlider").addEventListener("input", e => {
          if (this.gainNode) this.gainNode.gain.value = e.target.value;
        });
      }

      createBandButtons() {
        const container = document.getElementById("bandButtons");
        this.bands.forEach((band, i) => {
          const btn = document.createElement("button");
          btn.textContent = band.name;
          btn.addEventListener("click", () => this.toggleBand(i, btn));
          container.appendChild(btn);
        });
      }

      toggleBand(index, btn) {
        if (this.currentBand === index) {
          this.currentBand = null;
          btn.classList.remove("active");
        } else {
          this.currentBand = index;
          [...document.querySelectorAll("#bandButtons button")].forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
        }
        if (this.isPlaying) {
          this.stop();
          this.play();
        }
      }

      resizeCanvas() {
        const dpr = window.devicePixelRatio || 1;
        this.canvas.width = this.canvas.clientWidth * dpr;
        this.canvas.height = this.canvas.clientHeight * dpr;
        this.ctx.scale(dpr, dpr);
      }

      async loadFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (!this.audioContext) {
          this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }

        const arrayBuffer = await file.arrayBuffer();
        this.audioBuffer = await this.audioContext.decodeAudioData(arrayBuffer);

        document.getElementById("fileInfo").textContent =
          `Fichier : ${file.name} (${this.audioBuffer.duration.toFixed(1)}s)`;

        this.analyser = this.audioContext.createAnalyser();
        this.analyser.fftSize = 2048;
        this.startVisualization();
      }

      createSource() {
        this.source = this.audioContext.createBufferSource();
        this.source.buffer = this.audioBuffer;
        this.source.loop = this.isLooping;

        this.gainNode = this.audioContext.createGain();
        this.gainNode.gain.value = document.getElementById("volumeSlider").value;

        if (this.currentBand !== null) {
          const { low, high } = this.bands[this.currentBand];
          this.filterNode = this.createBandpassFilter(low, high);
          this.source.connect(this.filterNode.input);
          this.filterNode.output.connect(this.gainNode);
        } else {
          this.source.connect(this.gainNode);
        }

        this.gainNode.connect(this.analyser);
        this.analyser.connect(this.audioContext.destination);
      }

      createBandpassFilter(low, high) {
        const lowpass = this.audioContext.createBiquadFilter();
        lowpass.type = "lowpass";
        lowpass.frequency.value = high;

        const highpass = this.audioContext.createBiquadFilter();
        highpass.type = "highpass";
        highpass.frequency.value = low;

        highpass.connect(lowpass);

        return { input: highpass, output: lowpass };
      }

      play() {
        if (!this.audioBuffer || this.isPlaying) return;

        this.createSource();

        const offset = this.pausedAt || 0;
        this.startedAt = this.audioContext.currentTime - offset;
        this.source.start(0, offset);

        this.isPlaying = true;
        this.source.onended = () => {
          if (!this.isLooping) this.stop();
        };
      }

      pause() {
        if (this.source && this.isPlaying) {
          this.source.stop();
          this.pausedAt = this.audioContext.currentTime - this.startedAt;
          this.isPlaying = false;
        }
      }

      stop() {
        if (this.source) {
          this.source.stop();
          this.source.disconnect();
        }
        this.isPlaying = false;
        this.pausedAt = 0;
      }

      toggleLoop() {
        this.isLooping = !this.isLooping;
        document.getElementById("loopBtn").textContent = this.isLooping ? "üîÅ Boucle ON" : "üîÅ Boucle OFF";
        if (this.isPlaying) {
          this.stop();
          this.play();
        }
      }

      startVisualization() {
        const draw = () => {
          if (!this.analyser) return;
          const bufferLength = this.analyser.frequencyBinCount;
          const dataArray = new Uint8Array(bufferLength);
          this.analyser.getByteFrequencyData(dataArray);

          const width = this.canvas.clientWidth;
          const height = this.canvas.clientHeight;

          this.ctx.fillStyle = "black";
          this.ctx.fillRect(0, 0, width, height);

          // Dessin du spectre
          const barWidth = width / bufferLength;
          for (let i = 0; i < bufferLength; i++) {
            const value = dataArray[i];
            const barHeight = (value / 255) * height;
            this.ctx.fillStyle = "lime";
            this.ctx.fillRect(i * barWidth, height - barHeight, barWidth, barHeight);
          }

          // Ajout des zones des bandes
          this.bands.forEach(band => {
            const nyquist = this.audioContext.sampleRate / 2;
            const startIndex = Math.floor((band.low / nyquist) * bufferLength);
            const endIndex = Math.floor((band.high / nyquist) * bufferLength);

            const startX = startIndex * barWidth;
            const endX = endIndex * barWidth;

            this.ctx.fillStyle = "rgba(255,255,255,0.1)";
            this.ctx.fillRect(startX, 0, endX - startX, height);

            this.ctx.fillStyle = "rgba(255,255,255,0.3)";
            this.ctx.fillText(band.name, startX + 5, 15);
          });

          requestAnimationFrame(draw);
        };
        draw();
      }
    }

    new EarTrainer();
  </script>
</body>
</html>

