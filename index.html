<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Outil Ear Training</title>
<style>
body {
    font-family: Arial, sans-serif;
    background: #fff;
    color: #000;
    padding: 20px;
}
.container {
    max-width: 900px;
    margin: auto;
}
h1 { text-align: center; margin-bottom: 20px; }
#spectrumCanvas {
    width: 100%;
    height: 300px;
    background: #000;
    display: block;
    margin-bottom: 20px;
    position: relative;
}
.controls {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}
.control-btn {
    padding: 10px 20px;
    cursor: pointer;
}
.control-btn.active {
    background: #ff6b6b;
    color: #fff;
}
#fileInput {
    margin-bottom: 20px;
}
</style>
</head>
<body>
<div class="container">
<h1>Outil Ear Training</h1>
<input type="file" id="fileInput" accept="audio/*">
<canvas id="spectrumCanvas"></canvas>
<div class="controls">
    <button class="control-btn" id="playBtn">‚ñ∂Ô∏è Play</button>
    <button class="control-btn" id="pauseBtn">‚è∏Ô∏è Pause</button>
    <button class="control-btn" id="stopBtn">‚èπÔ∏è Stop</button>
    <button class="control-btn active" id="loopBtn">üîÑ Boucle</button>
</div>
<div id="bandInfo" style="margin-bottom:20px;font-weight:bold;"></div>
</div>

<script>
class EarTrainingTool {
    constructor() {
        this.audioCtx = null;
        this.audioBuffer = null;
        this.source = null;
        this.gainNode = null;
        this.analyser = null;
        this.isPlaying = false;
        this.isLooping = true; // boucle activ√©e par d√©faut
        this.currentBand = null;
        this.animationFrame = null;
        this.canvas = document.getElementById('spectrumCanvas');
        this.ctx = this.canvas.getContext('2d');

        this.frequencyBands = [
            { name: "Sub-Bass", low: 20, high: 60, color: "rgba(255,0,0,0.3)" },
            { name: "Bass", low: 60, high: 250, color: "rgba(255,165,0,0.3)" },
            { name: "Low-Mid", low: 250, high: 500, color: "rgba(255,255,0,0.3)" },
            { name: "Mid", low: 500, high: 2000, color: "rgba(0,255,0,0.3)" },
            { name: "High-Mid", low: 2000, high: 4000, color: "rgba(0,255,255,0.3)" },
            { name: "Treble", low: 4000, high: 8000, color: "rgba(0,0,255,0.3)" },
            { name: "High-Treble", low: 8000, high: 20000, color: "rgba(128,0,128,0.3)" }
        ];

        this.setupAudio();
        this.setupEvents();
        this.resizeCanvas();
        window.addEventListener('resize', () => this.resizeCanvas());
    }

    setupAudio() {
        this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        this.analyser = this.audioCtx.createAnalyser();
        this.analyser.fftSize = 2048;
    }

    setupEvents() {
        document.getElementById('fileInput').addEventListener('change', e => this.loadFile(e));
        document.getElementById('playBtn').addEventListener('click', () => this.play());
        document.getElementById('pauseBtn').addEventListener('click', () => this.pause());
        document.getElementById('stopBtn').addEventListener('click', () => this.stop());
        document.getElementById('loopBtn').addEventListener('click', () => this.toggleLoop());
        this.canvas.addEventListener('click', e => this.canvasClick(e));
    }

    resizeCanvas() {
        this.canvas.width = this.canvas.offsetWidth * window.devicePixelRatio;
        this.canvas.height = this.canvas.offsetHeight * window.devicePixelRatio;
        this.ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
    }

    async loadFile(e) {
        const file = e.target.files[0];
        if (!file) return;
        const arrayBuffer = await file.arrayBuffer();
        this.audioBuffer = await this.audioCtx.decodeAudioData(arrayBuffer);
        this.play();
    }

    play() {
        if(!this.audioBuffer) return;
        this.stop();
        this.source = this.audioCtx.createBufferSource();
        this.source.buffer = this.audioBuffer;
        this.source.loop = this.isLooping;

        this.gainNode = this.audioCtx.createGain();
        this.gainNode.gain.value = 0.7;

        if(this.currentBand) {
            const filter = this.createBandpassFilter(this.currentBand.low, this.currentBand.high);
            this.source.connect(filter.input);
            filter.output.connect(this.gainNode);
        } else {
            this.source.connect(this.gainNode);
        }

        this.gainNode.connect(this.analyser);
        this.analyser.connect(this.audioCtx.destination);
        this.source.start();
        this.isPlaying = true;
        this.visualize();
    }

    pause() { this.stop(); }

    stop() {
        if(this.source) {
            this.source.stop();
            this.source.disconnect();
            this.source = null;
        }
        this.isPlaying = false;
        if(this.animationFrame) cancelAnimationFrame(this.animationFrame);
    }

    toggleLoop() {
        this.isLooping = !this.isLooping;
        document.getElementById('loopBtn').classList.toggle('active', this.isLooping);
        if(this.isPlaying) this.play();
    }

    createBandpassFilter(low, high) {
        const hp = this.audioCtx.createBiquadFilter();
        hp.type = "highpass"; hp.frequency.value = low; hp.Q.value = 1;
        const lp = this.audioCtx.createBiquadFilter();
        lp.type = "lowpass"; lp.frequency.value = high; lp.Q.value = 1;
        hp.connect(lp);
        return { input: hp, output: lp };
    }

    canvasClick(e) {
        const rect = this.canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const width = this.canvas.offsetWidth;
        const minLog = Math.log10(20);
        const maxLog = Math.log10(20000);
        const freq = Math.pow(10, minLog + (x/width)*(maxLog-minLog));
        const band = this.frequencyBands.find(b => freq >= b.low && freq <= b.high);
        if(band) {
            this.currentBand = band;
            document.getElementById('bandInfo').innerHTML = `${band.name}<br>${band.low} - ${band.high} Hz`;
            if(this.isPlaying) this.play();
        }
    }

    visualize() {
        const ctx = this.ctx;
        const width = this.canvas.offsetWidth;
        const height = this.canvas.offsetHeight;
        const bufferLength = this.analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        const draw = () => {
            this.analyser.getByteFrequencyData(dataArray);
            ctx.clearRect(0,0,width,height);
            // dessiner les bandes
            this.frequencyBands.forEach(b => {
                const x1 = this.freqToX(b.low, width);
                const x2 = this.freqToX(b.high, width);
                ctx.fillStyle = this.currentBand===b ? b.color.replace('0.3','0.7') : b.color;
                ctx.fillRect(x1,0,x2-x1,height);
            });
            // dessiner le spectre
            ctx.beginPath();
            ctx.lineWidth = 2;
            ctx.strokeStyle = '#fff';
            const nyquist = this.audioCtx.sampleRate/2;
            for(let i=0;i<bufferLength;i++){
                const freq = i*nyquist/bufferLength;
                if(freq<20||freq>20000) continue;
                const x = this.freqToX(freq,width);
                const y = height - (dataArray[i]/255)*height;
                if(i===0) ctx.moveTo(x,y);
                else ctx.lineTo(x,y);
            }
            ctx.stroke();
            // axes fr√©quence
            ctx.fillStyle="#fff"; ctx.font="10px Arial";
            [20,50,100,200,500,1000,2000,5000,10000,20000].forEach(f=>{
                const x = this.freqToX(f,width);
                ctx.fillText(f>=1000?f/1000+'k':f, x-10, height-2);
            });
            this.animationFrame = requestAnimationFrame(draw);
        };
        draw();
    }

    freqToX(freq,width){
        const minLog = Math.log10(20);
        const maxLog = Math.log10(20000);
        return ((Math.log10(freq)-minLog)/(maxLog-minLog))*width;
    }
}

window.addEventListener('load', ()=>new EarTrainingTool());
</script>
</body>
</html>
