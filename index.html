<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Outil Ear Training</title>
<style>
body {
    margin: 0;
    padding: 20px;
    font-family: sans-serif;
    background: #fff;
    color: #000;
    text-align: center;
}
h1 {
    margin-bottom: 20px;
}
#spectrumContainer {
    position: relative;
    width: 100%;
    max-width: 900px;
    margin: 0 auto 20px;
}
canvas {
    width: 100%;
    height: 300px;
    background: black;
    display: block;
}
.controls, .upload-section {
    margin: 10px auto;
}
button {
    padding: 10px 20px;
    margin: 5px;
    font-size: 1em;
}
</style>
</head>
<body>
<h1>Outil Ear Training</h1>

<div class="upload-section">
    <input type="file" id="audioFile" accept="audio/*">
</div>

<div id="spectrumContainer">
    <canvas id="spectrum"></canvas>
</div>

<div class="controls">
    <button id="playBtn">‚ñ∂Ô∏è Lecture</button>
    <button id="pauseBtn">‚è∏Ô∏è Pause</button>
    <button id="stopBtn">‚èπÔ∏è Stop</button>
    <button id="loopBtn">üîÑ Boucle</button>
</div>

<script>
class EarTrainingTool{
    constructor(){
        this.audioContext=null;
        this.audioBuffer=null;
        this.source=null;
        this.gainNode=null;
        this.analyser=null;
        this.isPlaying=false;
        this.isLooping=false;
        this.currentBand=null;

        this.canvas=document.getElementById('spectrum');
        this.ctx=this.canvas.getContext('2d');

        this.bands=[
            {low:20,high:60,name:'Sub-Bass',color:'rgba(255,0,0,0.3)'},
            {low:60,high:250,name:'Bass',color:'rgba(255,165,0,0.3)'},
            {low:250,high:500,name:'Low-Mid',color:'rgba(255,255,0,0.3)'},
            {low:500,high:2000,name:'Mid',color:'rgba(0,255,0,0.3)'},
            {low:2000,high:4000,name:'High-Mid',color:'rgba(0,255,255,0.3)'},
            {low:4000,high:8000,name:'Treble',color:'rgba(0,0,255,0.3)'},
            {low:8000,high:20000,name:'High-Treble',color:'rgba(128,0,128,0.3)'}
        ];

        this.setupCanvas();
        this.initEvents();
        this.draw();
    }

    setupCanvas(){
        this.canvas.width=this.canvas.offsetWidth*window.devicePixelRatio;
        this.canvas.height=this.canvas.offsetHeight*window.devicePixelRatio;
        this.ctx.scale(window.devicePixelRatio,window.devicePixelRatio);
    }

    initEvents(){
        document.getElementById('audioFile').addEventListener('change', e=>this.loadAudio(e));
        document.getElementById('playBtn').addEventListener('click', ()=>this.play());
        document.getElementById('pauseBtn').addEventListener('click', ()=>this.pause());
        document.getElementById('stopBtn').addEventListener('click', ()=>this.stop());
        document.getElementById('loopBtn').addEventListener('click', ()=>this.toggleLoop());
        this.canvas.addEventListener('click', e=>this.onCanvasClick(e));

        window.addEventListener('resize', ()=>this.setupCanvas());
    }

    async loadAudio(event){
        const file=event.target.files[0];
        if(!file)return;
        try{
            this.audioContext=new (window.AudioContext||window.webkitAudioContext)();
            const arrayBuffer=await file.arrayBuffer();
            this.audioBuffer=await this.audioContext.decodeAudioData(arrayBuffer);
            this.setupNodes();
        }catch(err){
            console.error(err);
            alert('Erreur lors du chargement du fichier audio');
        }
    }

    setupNodes(){
        this.gainNode=this.audioContext.createGain();
        this.gainNode.gain.value=0.7;

        this.analyser=this.audioContext.createAnalyser();
        this.analyser.fftSize=2048;
        this.analyser.smoothingTimeConstant=0.8;

        this.gainNode.connect(this.analyser);
        this.analyser.connect(this.audioContext.destination);
    }

    play(){
        if(!this.audioBuffer)return;
        this.stop();
        this.source=this.audioContext.createBufferSource();
        this.source.buffer=this.audioBuffer;
        this.source.loop=this.isLooping;
        this.source.connect(this.gainNode);
        this.source.start();
        this.isPlaying=true;
    }

    pause(){this.stop();}
    stop(){
        if(this.source){this.source.stop(); this.source=null; this.isPlaying=false;}
    }

    toggleLoop(){
        this.isLooping=!this.isLooping;
        document.getElementById('loopBtn').textContent=this.isLooping?'üîÑ Boucle ON':'üîÑ Boucle';
        if(this.source)this.source.loop=this.isLooping;
    }

    frequencyToX(freq){
        const w=this.canvas.offsetWidth;
        const minLog=Math.log10(20);
        const maxLog=Math.log10(20000);
        return ((Math.log10(freq)-minLog)/(maxLog-minLog))*w;
    }

    draw(){
        const ctx=this.ctx;
        const w=this.canvas.offsetWidth;
        const h=this.canvas.offsetHeight;

        ctx.clearRect(0,0,w,h);

        // Dessiner bandes
        this.bands.forEach(b=>{
            const x1=this.frequencyToX(b.low);
            const x2=this.frequencyToX(b.high);

            if(this.currentBand===b){
                // bande s√©lectionn√©e plus opaque
                ctx.fillStyle=b.color.replace('0.3','0.8');
            }else{
                ctx.fillStyle=b.color;
            }
            ctx.fillRect(x1,0,x2-x1,h);

            // texte si s√©lectionn√©
            if(this.currentBand===b){
                ctx.fillStyle='white';
                ctx.font='14px Arial';
                ctx.textAlign='center';
                ctx.fillText(b.name,(x1+x2)/2,h/2-8);
                ctx.fillText(`${b.low}-${b.high} Hz`,(x1+x2)/2,h/2+10);
            }
        });

        // Dessiner axe des fr√©quences
        ctx.fillStyle='white';
        ctx.font='10px Arial';
        ctx.textAlign='center';
        const freqs=[20,50,100,200,500,1000,2000,5000,10000,20000];
        freqs.forEach(f=>{
            const x=this.frequencyToX(f);
            ctx.fillText(f>=1000?f/1000+'k':f,x,h-5);
        });

        requestAnimationFrame(()=>this.draw());
    }

    onCanvasClick(e){
        const rect=this.canvas.getBoundingClientRect();
        const x=e.clientX-rect.left;
        const freq=Math.pow(10, Math.log10(20)+x/this.canvas.offsetWidth*(Math.log10(20000)-Math.log10(20)));
        this.currentBand=null;
        for(const b of this.bands){
            if(freq>=b.low && freq<=b.high){
                this.currentBand=b;
                break;
            }
        }
    }
}

new EarTrainingTool();
</script>
</body>
</html>
