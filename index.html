<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ear Training Tool - CNSMDP</title>
<style>
body {margin:0; font-family:sans-serif; background:#1e1e2f; color:#fff; display:flex; justify-content:center; align-items:center; height:100vh;}
#container {position:relative; width:90%; max-width:1000px;}
canvas {width:100%; height:400px; background:#111; border-radius:10px;}
.freq-btns {position:absolute; top:0; left:0; width:100%; height:100%; display:flex; justify-content:space-between; pointer-events:none;}
.freq-btns button {
    pointer-events:auto;
    background:rgba(255,255,255,0.1); border:none; color:#fff; padding:5px; border-radius:5px;
    cursor:pointer; font-size:12px; flex:1; margin:2px;
    transition:0.2s;
}
.freq-btns button.active {background:rgba(255,107,107,0.7); color:#000;}
.controls {margin-top:10px; display:flex; gap:5px; justify-content:center;}
.controls button, .controls input[type=range]{padding:5px 10px; cursor:pointer;}
#volumeSlider {width:200px;}
</style>
</head>
<body>
<div id="container">
    <canvas id="spectrum"></canvas>
    <div class="freq-btns">
        <button data-band="sub-bass">Sub-Bass<br>20-60Hz</button>
        <button data-band="bass">Bass<br>60-250Hz</button>
        <button data-band="low-mid">Low-Mid<br>250-500Hz</button>
        <button data-band="mid">Mid<br>500-2000Hz</button>
        <button data-band="high-mid">High-Mid<br>2k-4kHz</button>
        <button data-band="treble">Treble<br>4k-8kHz</button>
        <button data-band="high-treble">High-Treble<br>8k-20kHz</button>
    </div>
    <div class="controls">
        <input type="file" id="audioFile" accept="audio/*">
        <button id="playBtn">‚ñ∂Ô∏è Play</button>
        <button id="pauseBtn">‚è∏Ô∏è Pause</button>
        <button id="stopBtn">‚èπÔ∏è Stop</button>
        <button id="loopBtn">üîÅ Loop</button>
        <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.7">
    </div>
</div>

<script>
class EarTrainer {
    constructor(){
        this.audioCtx=null;
        this.buffer=null;
        this.source=null;
        this.gainNode=null;
        this.filterNodes=[];
        this.analyser=null;
        this.isPlaying=false;
        this.isLoop=false;
        this.currentBand=null;
        this.canvas=document.getElementById('spectrum');
        this.ctx=this.canvas.getContext('2d');
        this.bands = {
            'sub-bass':[20,60],
            'bass':[60,250],
            'low-mid':[250,500],
            'mid':[500,2000],
            'high-mid':[2000,4000],
            'treble':[4000,8000],
            'high-treble':[8000,20000]
        };
        this.setupEvents();
        this.resizeCanvas();
        window.addEventListener('resize', ()=>this.resizeCanvas());
        requestAnimationFrame(()=>this.drawSpectrum());
    }

    setupEvents(){
        document.getElementById('audioFile').addEventListener('change',e=>this.loadFile(e));
        document.getElementById('playBtn').addEventListener('click',()=>this.play());
        document.getElementById('pauseBtn').addEventListener('click',()=>this.pause());
        document.getElementById('stopBtn').addEventListener('click',()=>this.stop());
        document.getElementById('loopBtn').addEventListener('click',()=>this.toggleLoop());
        document.getElementById('volumeSlider').addEventListener('input',e=>{if(this.gainNode)this.gainNode.gain.value=e.target.value;});

        document.querySelectorAll('.freq-btns button').forEach(btn=>{
            btn.addEventListener('click',e=>{
                let band=btn.getAttribute('data-band');
                if(this.currentBand===band){this.currentBand=null;}else{this.currentBand=band;}
                document.querySelectorAll('.freq-btns button').forEach(b=>b.classList.remove('active'));
                if(this.currentBand) btn.classList.add('active');
                if(this.isPlaying){this.stop(); this.play();}
            });
        });
    }

    resizeCanvas(){
        this.canvas.width=this.canvas.offsetWidth*window.devicePixelRatio;
        this.canvas.height=this.canvas.offsetHeight*window.devicePixelRatio;
        this.ctx.scale(window.devicePixelRatio,window.devicePixelRatio);
    }

    async loadFile(event){
        const file=event.target.files[0];
        if(!file)return;
        this.audioCtx=new (window.AudioContext||window.webkitAudioContext)();
        const arrayBuffer=await file.arrayBuffer();
        this.buffer=await this.audioCtx.decodeAudioData(arrayBuffer);
        this.analyser=this.audioCtx.createAnalyser();
        this.analyser.fftSize=2048;
    }

    createSteepFilter(low,high){
        // Cha√Æner deux filtres pour augmenter la pente (~12dB/oct)
        let filters=[];
        let hp1=this.audioCtx.createBiquadFilter(); hp1.type='highpass'; hp1.frequency.value=low;
        let hp2=this.audioCtx.createBiquadFilter(); hp2.type='highpass'; hp2.frequency.value=low;
        hp1.connect(hp2);
        filters.push(hp1,hp2);
        let lp1=this.audioCtx.createBiquadFilter(); lp1.type='lowpass'; lp1.frequency.value=high;
        let lp2=this.audioCtx.createBiquadFilter(); lp2.type='lowpass'; lp2.frequency.value=high;
        hp2.connect(lp1); lp1.connect(lp2);
        filters.push(lp1,lp2);
        return filters;
    }

    play(){
        if(!this.buffer)return;
        this.stop();
        this.source=this.audioCtx.createBufferSource();
        this.source.buffer=this.buffer;
        this.source.loop=this.isLoop;

        this.gainNode=this.audioCtx.createGain();
        this.gainNode.gain.value=document.getElementById('volumeSlider').value;

        if(this.currentBand){
            this.filterNodes=this.createSteepFilter(...this.bands[this.currentBand]);
            this.source.connect(this.filterNodes[0]);
            for(let i=0;i<this.filterNodes.length-1;i++) this.filterNodes[i].connect(this.filterNodes[i+1]);
            this.filterNodes[this.filterNodes.length-1].connect(this.gainNode);
        }else{
            this.source.connect(this.gainNode);
        }

        this.gainNode.connect(this.analyser);
        this.analyser.connect(this.audioCtx.destination);
        this.source.start();
        this.isPlaying=true;
        this.source.onended=()=>{this.isPlaying=false;}
    }

    pause(){if(this.source){this.source.stop(); this.isPlaying=false;}}
    stop(){if(this.source){this.source.stop(); this.source=null; this.isPlaying=false;}}
    toggleLoop(){this.isLoop=!this.isLoop;document.getElementById('loopBtn').textContent=this.isLoop?'üîÅ Loop ON':'üîÅ Loop';}

    drawSpectrum(){
        const ctx=this.ctx;
        const width=this.canvas.offsetWidth;
        const height=this.canvas.offsetHeight;
        ctx.clearRect(0,0,width,height);
        if(!this.analyser){requestAnimationFrame(()=>this.drawSpectrum()); return;}

        const bufferLength=this.analyser.frequencyBinCount;
        const dataArray=new Uint8Array(bufferLength);
        this.analyser.getByteFrequencyData(dataArray);

        // Dessiner spectre log
        ctx.beginPath();
        ctx.strokeStyle='#4facfe'; ctx.lineWidth=2;
        for(let i=0;i<bufferLength;i++){
            let freq=i*(this.audioCtx.sampleRate/2)/bufferLength;
            if(freq<20||freq>20000) continue;
            let x=(Math.log10(freq/20)/Math.log10(20000/20))*width;
            let y=height-(dataArray[i]/255)*height;
            if(i===0){ctx.moveTo(x,y);}else{ctx.lineTo(x,y);}
        }
        ctx.stroke();

        // Dessiner bandes de fr√©quence
        for(let b in this.bands){
            let [low,high]=this.bands[b];
            let x1=(Math.log10(low/20)/Math.log10(20000/20))*width;
            let x2=(Math.log10(high/20)/Math.log10(20000/20))*width;
            ctx.fillStyle=(this.currentBand===b)?'rgba(255,107,107,0.4)':'rgba(255,255,255,0.05)';
            ctx.fillRect(x1,0,x2-x1,height);
        }

        // Dessiner axe X logarithmique
        const freqs=[20,50,100,200,500,1000,2000,5000,10000,20000];
        ctx.fillStyle='#fff'; ctx.font='12px sans-serif'; ctx.textAlign='center';
        freqs.forEach(f=>{
            let x=(Math.log10(f/20)/Math.log10(20000/20))*width;
            ctx.fillText(f>=1000?f/1000+'k':f,x,height-5);
        });

        requestAnimationFrame(()=>this.drawSpectrum());
    }
}

new EarTrainer();
</script>
</body>
</html>
