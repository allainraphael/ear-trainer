<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Ear Training</title>
<style>
body { background:#111; color:white; font-family:Arial; text-align:center; }
canvas { background:#000; width:90%; height:400px; margin-top:20px; border-radius:12px; cursor:pointer; }
button { margin:5px; padding:10px 20px; border:none; border-radius:8px; cursor:pointer; }
.active { background:#4facfe; color:white; }
#resultsTable { margin:20px auto; border-collapse:collapse; width:80%; max-width:700px; }
#resultsTable th, #resultsTable td { border:1px solid #555; padding:8px; }
#resultsTable th { background:#222; }
.correct { color:lime; font-weight:bold; }
.incorrect { color:red; font-weight:bold; }
#replayBtn, #newQuizBtn, #quitQuizBtn { display:none; margin-top:15px; background:#4caf50; color:white; }
#newQuizBtn { background:#2196F3; }
#quitQuizBtn { background:#f44336; }
/* barre de progression */
#progressContainer { width:80%; max-width:600px; height:20px; background:#333; border-radius:10px; margin:15px auto; overflow:hidden; display:none; }
#progressBar { height:100%; width:0%; background:#4facfe; transition:width 0.5s ease; }
label, select { margin-top:10px; display:block; color:#fff; }
</style>
</head>
<body>
<h1>Ear Training</h1>

<input type="file" id="fileInput" accept="audio/*"><br>

<button id="playBtn">‚ñ∂Ô∏è Play/Pause</button>
<button id="loopBtn" class="active">üîÅ Boucle ON</button>
<button id="resetBtn">‚ôªÔ∏è Reset bande</button>
<button id="quizBtn">üéØ Quiz</button>
<br>

<label>Volume : <input type="range" id="volume" min="0" max="2" value="1" step="0.01"></label>

<label for="modeSelect">Mode bandes :</label>
<select id="modeSelect">
  <option value="full">Toutes les bandes</option>
  <option value="4bands1">Mode 1 (4 bandes)</option>
  <option value="4bands2">Mode 2 (4 bandes)</option>
  <option value="4bands3">Mode 3 (4 bandes)</option>
</select>

<div id="progressContainer">
  <div id="progressBar"></div>
</div>

<canvas id="analyser"></canvas>
<p id="quizMessage"></p>
<table id="resultsTable" style="display:none;">
  <thead>
    <tr>
      <th>#</th>
      <th>Ta r√©ponse</th>
      <th>Bonne r√©ponse</th>
      <th>R√©sultat</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<div>
  <button id="replayBtn">üîÅ Rejouer la s√©rie</button>
  <button id="newQuizBtn">üÜï Nouveau quiz</button>
  <button id="quitQuizBtn">‚ùå Quitter quiz</button>
</div>

<script>
class AudioApp {
  constructor() {
    // Elements
    this.fileInput = document.getElementById("fileInput");
    this.playBtn = document.getElementById("playBtn");
    this.loopBtn = document.getElementById("loopBtn");
    this.resetBtn = document.getElementById("resetBtn");
    this.quizBtn = document.getElementById("quizBtn");
    this.replayBtn = document.getElementById("replayBtn");
    this.newQuizBtn = document.getElementById("newQuizBtn");
    this.quitQuizBtn = document.getElementById("quitQuizBtn");
    this.volumeSlider = document.getElementById("volume");
    this.modeSelect = document.getElementById("modeSelect");
    this.canvas = document.getElementById("analyser");
    this.ctx = this.canvas.getContext("2d");
    this.quizMessage = document.getElementById("quizMessage");
    this.resultsTable = document.getElementById("resultsTable");
    this.resultsBody = this.resultsTable.querySelector("tbody");
    this.progressContainer = document.getElementById("progressContainer");
    this.progressBar = document.getElementById("progressBar");

    // Audio
    this.audioContext = null;
    this.source = null;
    this.analyser = null;
    this.gainNode = null;
    this.filterNode = null;
    this.buffer = null;
    this.isPlaying = false;
    this.isLooping = true;
    this.startTime = 0;
    this.pauseTime = 0;

    // Quiz / bands
    this.currentBand = null;
    this.quizBand = null;
    this.highlightBand = null;
    this.modeQuestion = false;
    this.modeReponse = false;
    this.quizActive = false;
    this.quizCount = 0;
    this.quizScore = 0;
    this.totalQuestions = 10;
    this.highlightBandOpacity = 0.3;
    this.clignotementInterval = null;
    this.animationId = null;

    // All bands
    this.allBands = {
      sub:{low:20,high:60,color:'rgba(255,0,0,0.5)',name:'Sub'},
      bass:{low:60,high:250,color:'rgba(255,165,0,0.5)',name:'Bass'},
      lowmid:{low:250,high:500,color:'rgba(255,255,0,0.5)',name:'Low Mid'},
      mid:{low:500,high:2000,color:'rgba(0,255,0,0.5)',name:'Mid'},
      highmid:{low:2000,high:4000,color:'rgba(0,255,255,0.5)',name:'High Mid'},
      presence:{low:4000,high:6000,color:'rgba(0,0,255,0.5)',name:'Presence'},
      brilliance:{low:6000,high:20000,color:'rgba(255,0,255,0.5)',name:'Brilliance'}
    };

    this.activeBands = {...this.allBands};

    this.bindEvents();
    this.resizeCanvas();
    window.addEventListener("resize",()=>this.resizeCanvas());
    this.canvas.addEventListener("click",(e)=>this.handleCanvasClick(e));
  }

  bindEvents(){
    this.fileInput.addEventListener("change", e=>this.loadFile(e));
    this.playBtn.addEventListener("click", ()=>this.togglePlay());
    this.loopBtn.addEventListener("click", ()=>this.toggleLoop());
    this.resetBtn.addEventListener("click", ()=>this.resetBand());
    this.quizBtn.addEventListener("click", ()=>this.startQuizSeries());
    this.replayBtn.addEventListener("click", ()=>this.startQuizSeries());
    this.newQuizBtn.addEventListener("click", ()=>this.startQuizSeries());
    this.quitQuizBtn.addEventListener("click", ()=>this.quitQuiz());
    this.volumeSlider.addEventListener("input", ()=>this.setVolume(this.volumeSlider.value));
    this.modeSelect.addEventListener("change", ()=>this.updateFrequencyBands());
  }

  resizeCanvas(){ this.canvas.width=this.canvas.offsetWidth; this.canvas.height=this.canvas.offsetHeight; }

  updateFrequencyBands(){
    const val = this.modeSelect.value;
    switch(val){
      case "full": this.activeBands = {...this.allBands}; break;
      case "4bands1": this.activeBands = {
        sub: this.allBands.sub, bass: this.allBands.bass, mid: this.allBands.mid, highmid: this.allBands.highmid
      }; break;
      case "4bands2": this.activeBands = {
        lowmid: this.allBands.lowmid, mid: this.allBands.mid, presence: this.allBands.presence, brilliance: this.allBands.brilliance
      }; break;
      case "4bands3": this.activeBands = {
        sub: this.allBands.sub, lowmid: this.allBands.lowmid, presence: this.allBands.presence, brilliance: this.allBands.brilliance
      }; break;
    }
    this.currentBand=null;
    if(this.isPlaying) this.play();
  }

  async loadFile(e){
    const file = e.target.files[0];
    if(!file) return;
    if(!this.audioContext) this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const arrayBuffer = await file.arrayBuffer();
    this.buffer = await this.audioContext.decodeAudioData(arrayBuffer);

    if(!this.gainNode){
      this.gainNode = this.audioContext.createGain();
      this.analyser = this.audioContext.createAnalyser();
      this.analyser.fftSize = 2048;
      this.floatData = new Float32Array(this.analyser.frequencyBinCount);
      this.gainNode.connect(this.analyser);
      this.analyser.connect(this.audioContext.destination);
      this.setVolume(this.volumeSlider.value);
    }

    this.pauseTime = 0;
    this.play();
  }

  play(filteredBand=null){
    if(!this.buffer) return;
    if(this.audioContext.state==="suspended") this.audioContext.resume();
    if(this.source){ try{this.source.stop();}catch(e){} this.source.disconnect(); }

    this.source = this.audioContext.createBufferSource();
    this.source.buffer = this.buffer;
    this.source.loop = this.isLooping;

    if(this.filterNode){ this.filterNode.disconnect(); this.filterNode=null; }

    let bandKey = filteredBand || this.currentBand;
    if(bandKey){
      const band = this.activeBands[bandKey];
      const filter = this.audioContext.createBiquadFilter();
      filter.type="bandpass";
      filter.frequency.value = Math.sqrt(band.low*band.high);
      filter.Q.value = filter.frequency.value/(band.high-band.low);
      this.source.connect(filter);
      filter.connect(this.gainNode);
      this.filterNode = filter;
    } else { this.source.connect(this.gainNode); }

    this.startTime = this.audioContext.currentTime - this.pauseTime;
    this.source.start(0,this.pauseTime);
    this.isPlaying=true;
    if(!this.animationId) this.animate();
  }

  togglePlay(){
    if(!this.isPlaying){ this.play(); }
    else{ if(this.source){ this.source.stop(); } this.pauseTime=this.audioContext.currentTime-this.startTime; this.isPlaying=false; if(this.animationId){ cancelAnimationFrame(this.animationId); this.animationId=null; } }
  }

  toggleLoop(){
    this.isLooping = !this.isLooping;
    this.loopBtn.classList.toggle("active", this.isLooping);
    this.loopBtn.textContent = this.isLooping?"üîÅ Boucle ON":"üîÅ Boucle OFF";
    if(this.source) this.source.loop=this.isLooping;
  }

  setVolume(val){ if(this.gainNode) this.gainNode.gain.value=val; }

  resetBand(){ this.currentBand=null; if(this.isPlaying) this.play(); }

  startQuizSeries(){
    this.quizActive=true; this.quizCount=0; this.quizScore=0; this.resultsBody.innerHTML="";
    this.resultsTable.style.display="table"; this.replayBtn.style.display="inline-block"; 
    this.newQuizBtn.style.display="inline-block"; this.quitQuizBtn.style.display="inline-block"; 
    this.progressContainer.style.display="block"; this.progressBar.style.width="0%";
    this.startQuiz();
  }

  startQuiz(){
    if(this.quizCount>=this.totalQuestions){
      this.quizActive=false; this.showMessage(`üèÜ S√©rie termin√©e ! Score : ${this.quizScore}/${this.totalQuestions}`);
      this.highlightBand=null;
      if(this.source){ try{this.source.stop();}catch(e){} this.isPlaying=false; }
      this.progressBar.style.width="100%"; return;
    }
    this.quizCount++;
    const keys = Object.keys(this.activeBands);
    let random;
    do { random = keys[Math.floor(Math.random()*keys.length)]; } while(random===this.quizBand);
    this.quizBand=random; this.currentBand=null; this.highlightBand=null; this.modeQuestion=true; this.modeReponse=false;
    if(this.source){ try{this.source.stop();}catch(e){} this.pauseTime=this.audioContext.currentTime-this.startTime; }
    this.playQuizBand();
    this.showMessage(`üéØ Question ${this.quizCount}/${this.totalQuestions} : Devinez la bande !`);
    this.progressBar.style.width=((this.quizCount-1)/this.totalQuestions*100)+"%";
  }

  playQuizBand(){ if(!this.buffer) return; if(this.source){ try{this.source.stop();}catch(e){} this.source.disconnect(); }
    this.source=this.audioContext.createBufferSource(); this.source.buffer=this.buffer; this.source.loop=this.isLooping;
    const band=this.activeBands[this.quizBand];
    const filter=this.audioContext.createBiquadFilter(); filter.type="bandpass"; filter.frequency.value=Math.sqrt(band.low*band.high); filter.Q.value=filter.frequency.value/(band.high-band.low);
    this.source.connect(filter); filter.connect(this.gainNode); this.filterNode=filter;
    this.startTime=this.audioContext.currentTime-this.pauseTime; this.source.start(0,this.pauseTime); this.isPlaying=true; if(!this.animationId) this.animate();
  }

  playHighlightBand(bandKey,duration=1500){
    if(!this.buffer) return; if(this.source){ try{this.source.stop();}catch(e){} this.source.disconnect(); }
    this.source=this.audioContext.createBufferSource(); this.source.buffer=this.buffer; this.source.loop=false;
    const band=this.activeBands[bandKey]; const filter=this.audioContext.createBiquadFilter(); filter.type="bandpass"; filter.frequency.value=Math.sqrt(band.low*band.high); filter.Q.value=filter.frequency.value/(band.high-band.low);
    this.source.connect(filter); filter.connect(this.gainNode); this.filterNode=filter; this.startTime=this.audioContext.currentTime; this.source.start(0); this.isPlaying=true;
    let flashes=0; if(this.clignotementInterval) clearInterval(this.clignotementInterval);
    this.clignotementInterval=setInterval(()=>{ this.highlightBandOpacity=(this.highlightBandOpacity===0.3)?0.8:0.3; flashes++; if(flashes>=6){ clearInterval(this.clignotementInterval); this.highlightBandOpacity=0.3; } },100);
    setTimeout(()=>{ if(this.source){ try{this.source.stop();}catch(e){} } this.isPlaying=false; },duration);
  }

  showMessage(msg){ this.quizMessage.textContent=msg; }

  addResult(question,answer,correct){
    const tr=document.createElement("tr"); const tdQ=document.createElement("td"); const tdA=document.createElement("td"); const tdC=document.createElement("td"); const tdR=document.createElement("td");
    tdQ.textContent=question; tdA.textContent=answer?this.activeBands[answer].name:"‚Äî"; tdC.textContent=this.activeBands[correct].name;
    if(answer===correct){ tdR.textContent="‚úÖ"; tdR.classList.add("correct"); } else { tdR.textContent="‚ùå"; tdR.classList.add("incorrect"); }
    tr.appendChild(tdQ); tr.appendChild(tdA); tr.appendChild(tdC); tr.appendChild(tdR); this.resultsBody.appendChild(tr);
  }

  handleCanvasClick(e){
    const rect=this.canvas.getBoundingClientRect(); const x=e.clientX-rect.left; const width=this.canvas.width;
    for(const key in this.activeBands){
      const band=this.activeBands[key]; const x1=this.frequencyToX(band.low,width); const x2=this.frequencyToX(band.high,width);
      if(x>=x1 && x<=x2){
        if(this.quizActive && this.quizBand && this.modeQuestion){
          const correct=this.quizBand;
          if(key===correct){ this.quizScore++; this.showMessage(`‚úÖ Bonne r√©ponse ! C'√©tait ${this.activeBands[correct].name}`); }
          else { this.showMessage(`‚ùå Mauvaise r√©ponse ! C'√©tait ${this.activeBands[correct].name}`); }
          this.addResult(this.quizCount,key,correct);
          this.highlightBand=correct; this.quizBand=null; this.modeQuestion=false; this.modeReponse=true;
          this.playHighlightBand(this.highlightBand,2000);
          setTimeout(()=>this.startQuiz(),2000);
        } else { this.currentBand=key; if(this.isPlaying) this.play(); }
        break;
      }
    }
  }

  quitQuiz(){
    this.quizActive=false; this.quizBand=null; this.highlightBand=null; this.modeQuestion=false; this.modeReponse=false;
    if(this.source){ try{this.source.stop();}catch(e){} this.isPlaying=false; }
    this.resultsTable.style.display="none"; this.progressContainer.style.display="none";
    this.replayBtn.style.display="none"; this.newQuizBtn.style.display="none"; this.quitQuizBtn.style.display="none";
    this.showMessage("Mode libre activ√© : √©coutez les bandes librement !"); this.currentBand=null; this.play();
  }

  frequencyToX(freq,width){
    const min=20,max=20000; const logMin=Math.log10(min),logMax=Math.log10(max); const ratio=(Math.log10(freq)-logMin)/(logMax-logMin); return ratio*width;
  }

  dbToY(db,height){ const maxDb=20; let minDb=-100; if(this.floatData){ let minVal=Math.min(...this.floatData); if(minVal>-100) minDb=Math.floor(minVal/10)*10; } const ratio=(db-minDb)/(maxDb-minDb); return height-(ratio*height); }

  drawSpectrum(){
    const ctx=this.ctx, width=this.canvas.width, height=this.canvas.height;
    ctx.fillStyle='#000'; ctx.fillRect(0,0,width,height);

    if(this.modeQuestion){
      for(const key in this.activeBands){
        const band=this.activeBands[key]; const x1=this.frequencyToX(band.low,width); const x2=this.frequencyToX(band.high,width);
        ctx.fillStyle='rgba(255,255,255,0.1)'; ctx.fillRect(x1,0,x2-x1,height);
        ctx.fillStyle='#fff'; ctx.fillText(band.name,(x1+x2)/2,20);
      }
    }

    if(this.highlightBand){
      const band=this.activeBands[this.highlightBand];
      const x1=this.frequencyToX(band.low,width); const x2=this.frequencyToX(band.high,width);
      ctx.fillStyle=`rgba(0,255,0,${this.highlightBandOpacity})`; ctx.fillRect(x1,0,x2-x1,height);
      ctx.fillStyle='#fff'; ctx.fillText(band.name,(x1+x2)/2,40);
    }

    if(this.analyser){
      this.analyser.getFloatFrequencyData(this.floatData);
      ctx.strokeStyle='#4facfe'; ctx.beginPath();
      const len=this.floatData.length;
      for(let i=0;i<len;i++){
        const freq=i*this.audioContext.sampleRate/2/len;
        const db=this.floatData[i]; const y=this.dbToY(db,height); const x=this.frequencyToX(freq,width);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.stroke();
    }
  }

  animate(){
    this.drawSpectrum();
    this.animationId=requestAnimationFrame(()=>this.animate());
  }
}

const app=new AudioApp();
</script>
</body>
</html>
