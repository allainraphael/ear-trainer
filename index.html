<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ear Training Tool</title>
<style>
body {
    font-family: Arial, sans-serif;
    background: #1e3c72;
    color: white;
    padding: 20px;
    margin: 0;
}
.container {
    max-width: 900px;
    margin: auto;
    background: rgba(255,255,255,0.1);
    padding: 20px;
    border-radius: 15px;
    text-align: center;
}
h1 { margin-bottom: 20px; }
#spectrumContainer {
    position: relative;
    width: 100%;
    height: 300px;
    background: rgba(0,0,0,0.3);
    margin-bottom: 20px;
    border-radius: 10px;
}
#spectrum {
    width: 100%;
    height: 100%;
    display: block;
    border-radius: 10px;
}
.controls, .volume-control {
    margin: 10px 0;
}
button {
    padding: 10px 20px;
    margin: 5px;
    border: none;
    border-radius: 5px;
    background: #4facfe;
    color: white;
    cursor: pointer;
}
button.active { background: #ff6b6b; }
.freq-band-btn {
    padding: 5px 10px;
    margin: 2px;
    border-radius: 5px;
    border: 1px solid white;
    cursor: pointer;
    background: rgba(255,255,255,0.1);
    color: white;
}
.freq-band-btn.active { background: #ff6b6b; color: black; }
</style>
</head>
<body>
<div class="container">
    <h1>Ear Training Tool</h1>

    <input type="file" id="audioFile" accept="audio/*"><br><br>

    <div id="spectrumContainer">
        <canvas id="spectrum"></canvas>
    </div>

    <div class="controls">
        <button id="playBtn">‚ñ∂Ô∏è Lecture</button>
        <button id="pauseBtn">‚è∏Ô∏è Pause</button>
        <button id="stopBtn">‚èπÔ∏è Stop</button>
        <button id="loopBtn">üîÑ Boucle</button>
    </div>

    <div class="volume-control">
        Volume: <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.7">
        <span id="volumeValue">70%</span>
    </div>

    <div id="freqBands">
        <button class="freq-band-btn" data-band="sub-bass">Sub-Bass</button>
        <button class="freq-band-btn" data-band="bass">Bass</button>
        <button class="freq-band-btn" data-band="low-mid">Low-Mid</button>
        <button class="freq-band-btn" data-band="mid">Mid</button>
        <button class="freq-band-btn" data-band="high-mid">High-Mid</button>
        <button class="freq-band-btn" data-band="treble">Treble</button>
        <button class="freq-band-btn" data-band="high-treble">High-Treble</button>
    </div>
</div>

<script>
class EarTrainingTool {
    constructor() {
        this.audioCtx = null;
        this.audioBuffer = null;
        this.source = null;
        this.gainNode = null;
        this.analyser = null;
        this.isPlaying = false;
        this.isLooping = false;
        this.currentBand = null;

        this.canvas = document.getElementById('spectrum');
        this.ctx = this.canvas.getContext('2d');

        this.bands = {
            'sub-bass': {low:20, high:60, color:'#ff6b6b'},
            'bass': {low:60, high:250, color:'#ffa500'},
            'low-mid': {low:250, high:500, color:'#ffff00'},
            'mid': {low:500, high:2000, color:'#00ff00'},
            'high-mid': {low:2000, high:4000, color:'#00ffff'},
            'treble': {low:4000, high:8000, color:'#0080ff'},
            'high-treble': {low:8000, high:20000, color:'#8000ff'}
        };

        this.setupEventListeners();
        this.resizeCanvas();
        window.addEventListener('resize', ()=>this.resizeCanvas());
    }

    setupEventListeners() {
        document.getElementById('audioFile').addEventListener('change', e=>this.loadAudio(e));
        document.getElementById('playBtn').addEventListener('click', ()=>this.play());
        document.getElementById('pauseBtn').addEventListener('click', ()=>this.pause());
        document.getElementById('stopBtn').addEventListener('click', ()=>this.stop());
        document.getElementById('loopBtn').addEventListener('click', ()=>this.toggleLoop());
        document.getElementById('volumeSlider').addEventListener('input', e=>this.setVolume(e.target.value));

        document.querySelectorAll('.freq-band-btn').forEach(btn=>{
            btn.addEventListener('click', e=>{
                const band = e.target.getAttribute('data-band');
                this.selectBand(band);
            });
        });
    }

    resizeCanvas() {
        const canvas = this.canvas;
        canvas.width = canvas.offsetWidth * window.devicePixelRatio;
        canvas.height = canvas.offsetHeight * window.devicePixelRatio;
        this.ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
    }

    async loadAudio(event) {
        const file = event.target.files[0];
        if(!file) return;

        this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const arrayBuffer = await file.arrayBuffer();
        this.audioBuffer = await this.audioCtx.decodeAudioData(arrayBuffer);

        this.analyser = this.audioCtx.createAnalyser();
        this.analyser.fftSize = 2048;

        this.drawSpectrumLoop();
    }

    createBandpass(low, high) {
        const highpass = this.audioCtx.createBiquadFilter();
        highpass.type = 'highpass';
        highpass.frequency.value = low;
        highpass.Q.value = 5; // Q augment√© pour pente plus raide

        const lowpass = this.audioCtx.createBiquadFilter();
        lowpass.type = 'lowpass';
        lowpass.frequency.value = high;
        lowpass.Q.value = 5;

        highpass.connect(lowpass);
        return {input: highpass, output: lowpass};
    }

    selectBand(band) {
        if(this.currentBand===band){this.currentBand=null;}
        else{this.currentBand=band;}
        document.querySelectorAll('.freq-band-btn').forEach(btn=>{
            btn.classList.remove('active');
            if(btn.getAttribute('data-band')===this.currentBand) btn.classList.add('active');
        });
        if(this.isPlaying){this.stop(); this.play();}
    }

    play() {
        if(!this.audioBuffer) return;
        this.stop();

        this.source = this.audioCtx.createBufferSource();
        this.source.buffer = this.audioBuffer;
        this.source.loop = this.isLooping;

        this.gainNode = this.audioCtx.createGain();
        this.gainNode.gain.value = document.getElementById('volumeSlider').value;

        let nodeChain = this.source;
        if(this.currentBand){
            const f = this.bands[this.currentBand];
            const bandFilters = this.createBandpass(f.low,f.high);
            nodeChain.connect(bandFilters.input);
            nodeChain = bandFilters.output;
        }
        nodeChain.connect(this.gainNode);
        this.gainNode.connect(this.analyser);
        this.analyser.connect(this.audioCtx.destination);

        this.source.start();
        this.isPlaying=true;
        this.source.onended = ()=>{this.isPlaying=false;}
    }

    pause(){if(this.source && this.isPlaying){this.source.stop(); this.isPlaying=false;}}
    stop(){if(this.source){this.source.stop(); this.source=null; this.isPlaying=false;}}

    toggleLoop(){
        this.isLooping = !this.isLooping;
        document.getElementById('loopBtn').classList.toggle('active', this.isLooping);
    }

    setVolume(val){
        document.getElementById('volumeValue').textContent = Math.round(val*100)+'%';
        if(this.gainNode) this.gainNode.gain.value=val;
    }

    drawSpectrumLoop(){
        const ctx=this.ctx;
        const canvas=this.canvas;
        const draw=()=>{
            if(!this.analyser){requestAnimationFrame(draw); return;}
            const width = canvas.offsetWidth;
            const height = canvas.offsetHeight;
            ctx.clearRect(0,0,width,height);

            const data = new Uint8Array(this.analyser.frequencyBinCount);
            this.analyser.getByteFrequencyData(data);

            const nyquist = this.audioCtx.sampleRate/2;
            ctx.fillStyle='rgba(0,0,0,0.1)'; ctx.fillRect(0,0,width,height);

            // Dessiner bandes
            Object.keys(this.bands).forEach(k=>{
                const b=this.bands[k];
                const x1 = Math.log10(b.low/20)/Math.log10(20000/20)*width;
                const x2 = Math.log10(b.high/20)/Math.log10(20000/20)*width;
                ctx.fillStyle=this.currentBand===k?b.color+'aa':b.color+'50';
                ctx.fillRect(x1,0,x2-x1,height);
            });

            ctx.beginPath();
            ctx.strokeStyle='#4facfe';
            ctx.lineWidth=2;
            for(let i=0;i<data.length;i++){
                const freq = i*nyquist/data.length;
                if(freq<20 || freq>20000) continue;
                const x = Math.log10(freq/20)/Math.log10(20000/20)*width;
                const y = height-(data[i]/255)*height;
                if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
            }
            ctx.stroke();

            // Dessiner labels fr√©quences
            ctx.fillStyle='white';
            ctx.font='10px Arial';
            const freqs=[20,50,100,200,500,1000,2000,5000,10000,20000];
            freqs.forEach(f=>{
                const x=Math.log10(f/20)/Math.log10(20000/20)*width;
                const label=f>=1000?f/1000+'k':f;
                ctx.fillText(label+'Hz',x,10);
            });

            requestAnimationFrame(draw);
        };
        draw();
    }
}

window.addEventListener('load',()=>new EarTrainingTool());
</script>
</body>
</html>
