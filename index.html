<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Ear Training</title>
<style>
body { background:#111; color:white; font-family:Arial; text-align:center; }
canvas { background:#000; width:90%; height:400px; margin-top:20px; border-radius:12px; cursor:pointer; }
button { margin:5px; padding:10px 20px; border:none; border-radius:8px; cursor:pointer; }
.active { background:#4facfe; color:white; }
</style>
</head>
<body>
<h1>Ear Training</h1>
<input type="file" id="fileInput" accept="audio/*"><br>
<button id="playBtn">▶️ Play/Pause</button>
<button id="loopBtn" class="active">🔁 Boucle ON</button>
<button id="resetBtn">♻️ Reset bande</button>
<button id="quizBtn">🎯 Quiz</button>
<br>
<label>Volume : <input type="range" id="volume" min="0" max="2" value="1" step="0.01"></label>
<br>
<canvas id="analyser"></canvas>
<p id="quizMessage"></p>

<script>
class AudioApp {
  constructor() {
    this.fileInput = document.getElementById("fileInput");
    this.playBtn = document.getElementById("playBtn");
    this.loopBtn = document.getElementById("loopBtn");
    this.resetBtn = document.getElementById("resetBtn");
    this.quizBtn = document.getElementById("quizBtn");
    this.volumeSlider = document.getElementById("volume");
    this.canvas = document.getElementById("analyser");
    this.ctx = this.canvas.getContext("2d");

    this.audioContext = null;
    this.source = null;
    this.analyser = null;
    this.gainNode = null;
    this.filterNode = null;
    this.buffer = null;
    this.isPlaying = false;
    this.isLooping = true;
    this.startTime = 0;
    this.pauseTime = 0;

    this.currentBand = null;
    this.frequencyBands = {
      sub:{low:20,high:60,color:'rgba(255,0,0,0.5)',name:'Sub'},
      bass:{low:60,high:250,color:'rgba(255,165,0,0.5)',name:'Bass'},
      lowmid:{low:250,high:500,color:'rgba(255,255,0,0.5)',name:'Low Mid'},
      mid:{low:500,high:2000,color:'rgba(0,255,0,0.5)',name:'Mid'},
      highmid:{low:2000,high:4000,color:'rgba(0,255,255,0.5)',name:'High Mid'},
      presence:{low:4000,high:6000,color:'rgba(0,0,255,0.5)',name:'Presence'},
      brilliance:{low:6000,high:20000,color:'rgba(255,0,255,0.5)',name:'Brilliance'}
    };

    this.bindEvents();
    this.resizeCanvas();
    window.addEventListener("resize",()=>this.resizeCanvas());
    this.canvas.addEventListener("click",(e)=>this.handleCanvasClick(e));
  }

  bindEvents(){
    this.fileInput.addEventListener("change", e=>this.loadFile(e));
    this.playBtn.addEventListener("click", ()=>this.togglePlay());
    this.loopBtn.addEventListener("click", ()=>this.toggleLoop());
    this.resetBtn.addEventListener("click", ()=>this.resetBand());
    this.quizBtn.addEventListener("click", ()=>this.startQuiz());
    this.volumeSlider.addEventListener("input", ()=>this.setVolume(this.volumeSlider.value));
  }

  resizeCanvas(){
    this.canvas.width = this.canvas.offsetWidth;
    this.canvas.height = this.canvas.offsetHeight;
  }

  async loadFile(e){
    const file = e.target.files[0];
    if(!file) return;

    if(!this.audioContext) this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const arrayBuffer = await file.arrayBuffer();
    this.buffer = await this.audioContext.decodeAudioData(arrayBuffer);

    if(!this.gainNode){
      this.gainNode = this.audioContext.createGain();
      this.analyser = this.audioContext.createAnalyser();
      this.analyser.fftSize = 2048;
      this.floatData = new Float32Array(this.analyser.frequencyBinCount);
      this.gainNode.connect(this.analyser);
      this.analyser.connect(this.audioContext.destination);
      this.setVolume(this.volumeSlider.value);
    }

    this.pauseTime = 0;
    this.play();
  }

  play(){
    if(!this.buffer) return;

    if(this.source){
      this.source.stop();
      this.source.disconnect();
    }

    this.source = this.audioContext.createBufferSource();
    this.source.buffer = this.buffer;
    this.source.loop = this.isLooping;

    if(this.filterNode){
      this.filterNode.disconnect();
      this.filterNode = null;
    }
    if(this.currentBand){
      const band = this.frequencyBands[this.currentBand];
      const filter = this.audioContext.createBiquadFilter();
      filter.type = "bandpass";
      filter.frequency.value = Math.sqrt(band.low*band.high);
      filter.Q.value = filter.frequency.value/(band.high-band.low);
      this.source.connect(filter);
      filter.connect(this.gainNode);
      this.filterNode = filter;
    } else {
      this.source.connect(this.gainNode);
    }

    this.startTime = this.audioContext.currentTime - this.pauseTime;
    this.source.start(0,this.pauseTime);
    this.isPlaying = true;
    this.animate();
  }

  togglePlay(){
    if(!this.isPlaying){ this.play(); }
    else{
      this.source.stop();
      this.pauseTime = this.audioContext.currentTime - this.startTime;
      this.isPlaying = false;
    }
  }

  toggleLoop(){
    this.isLooping = !this.isLooping;
    this.loopBtn.classList.toggle("active", this.isLooping);
    this.loopBtn.textContent = this.isLooping ? "🔁 Boucle ON" : "🔁 Boucle OFF";
  }

  setVolume(val){
    if(this.gainNode) this.gainNode.gain.value = val;
  }

  resetBand(){
    this.currentBand = null;
    if(this.isPlaying){
      this.source.stop();
      this.pauseTime = this.audioContext.currentTime - this.startTime;
      this.play();
    }
  }

  startQuiz(){
    const keys = Object.keys(this.frequencyBands);
    const random = keys[Math.floor(Math.random()*keys.length)];
    this.currentBand = random;
    if(this.isPlaying){
      this.source.stop();
      this.pauseTime = this.audioContext.currentTime - this.startTime;
      this.play();
    }
    document.getElementById("quizMessage").textContent =
      "🎯 Quelle est cette bande ? (" + this.frequencyBands[random].name + ")";
  }

  frequencyToX(freq,width){
    const min=20, max=20000;
    const logMin=Math.log10(min), logMax=Math.log10(max);
    const ratio=(Math.log10(freq)-logMin)/(logMax-logMin);
    return ratio*width;
  }

  dbToY(db,height){
    const minDb=-100, maxDb=20;
    const ratio=(db-minDb)/(maxDb-minDb);
    return height - (ratio*height);
  }

  handleCanvasClick(e){
    const rect = this.canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const width = this.canvas.width;

    for(const key in this.frequencyBands){
      const band = this.frequencyBands[key];
      const x1 = this.frequencyToX(band.low,width);
      const x2 = this.frequencyToX(band.high,width);
      if(x >= x1 && x <= x2){
        this.currentBand = key;
        if(this.isPlaying){
          this.source.stop();
          this.pauseTime = this.audioContext.currentTime - this.startTime;
          this.play();
        }
        break;
      }
    }
  }

  drawSpectrum(){
    const ctx = this.ctx;
    const width = this.canvas.width;
    const height = this.canvas.height;
    ctx.fillStyle = '#000';
    ctx.fillRect(0,0,width,height);

    if(!this.analyser) return;
    this.analyser.getFloatFrequencyData(this.floatData);

    // repères dB
    const dBsteps = [20,0,-20,-40,-60,-80,-100];
    ctx.fillStyle="#aaa";
    ctx.font="10px Arial";
    ctx.textAlign="right";
    dBsteps.forEach(db=>{
      const y = this.dbToY(db,height);
      ctx.fillText(db+" dB", width-2, y-2);
    });

    // bandes
    for(const key in this.frequencyBands){
      const band = this.frequencyBands[key];
      const x1 = this.frequencyToX(band.low,width);
      const x2 = this.frequencyToX(band.high,width);
      ctx.fillStyle = (this.currentBand===key)?band.color:band.color.replace("0.5","0.2");
      ctx.fillRect(x1,0,x2-x1,height);

      ctx.fillStyle='#fff';
      ctx.font='12px Arial';
      ctx.textAlign='center';
      ctx.fillText(`${band.name}`,(x1+x2)/2,20);
      ctx.fillText(`${band.low}-${band.high} Hz`,(x1+x2)/2,35);
    }

    // repères Hz
    const freqs = [20,50,100,200,500,1000,2000,5000,10000,20000];
    ctx.fillStyle="#aaa";
    ctx.font="10px Arial";
    ctx.textAlign="left";
    freqs.forEach(freq=>{
      const x = this.frequencyToX(freq,width);
      ctx.fillText((freq>=1000?(freq/1000)+"k":freq)+"Hz", x+2, height-5);
    });

    // spectre
    ctx.beginPath();
    ctx.strokeStyle='#4facfe';
    ctx.lineWidth=2;
    for(let i=0;i<this.floatData.length;i++){
      const freq = (i*this.audioContext.sampleRate/2)/this.floatData.length;
      if(freq<20||freq>20000) continue;
      const x = this.frequencyToX(freq,width);
      const dB = this.floatData[i];
      const y = this.dbToY(dB,height);
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();
  }

  animate(){
    requestAnimationFrame(()=>this.animate());
    this.drawSpectrum();
  }
}

new AudioApp();
</script>
</body>
</html>
