<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Quiz Audio</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; text-align: center; }
    canvas { border: 1px solid black; margin-top: 20px; }
    #quizMessage { font-size: 20px; margin-top: 15px; font-weight: bold; }
    #quizMessage.correct { color: green; }
    #quizMessage.wrong { color: red; }
    #progressContainer { width: 100%; background: #eee; height: 20px; margin-top: 10px; border-radius: 10px; overflow: hidden; }
    #progressBar { width: 0%; height: 100%; background: #4caf50; transition: width 0.5s; }
    #endButtons { margin-top: 15px; display: none; }
    #endButtons button { margin: 5px; padding: 8px 16px; font-size: 16px; }
  </style>
</head>
<body>
  <h1>Quiz d'Écoute des Bandes Fréquentielles</h1>
  <input type="file" id="fileInput" accept="audio/*"><br><br>
  <button id="playButton">Play/Pause</button>
  <button id="loopButton">Loop: Off</button>
  <button id="quizButton">Mode Quiz</button>

  <canvas id="canvas" width="800" height="300"></canvas>
  <div id="quizMessage"></div>
  <div id="progressContainer"><div id="progressBar"></div></div>

  <div id="endButtons">
    <button id="replayQuiz">Rejouer le Quiz</button>
    <button id="newQuiz">Nouveau Quiz</button>
  </div>

  <script>
    class AudioQuiz {
      constructor() {
        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        this.analyser = this.audioContext.createAnalyser();
        this.analyser.fftSize = 2048;
        this.source = null;
        this.buffer = null;
        this.isPlaying = false;
        this.isLooping = false;

        this.bands = [
          { name: "Graves", freq: 100 },
          { name: "Bas Médiums", freq: 400 },
          { name: "Médiums", freq: 1000 },
          { name: "Hauts Médiums", freq: 3000 },
          { name: "Aigus", freq: 8000 }
        ];
        this.filters = [];

        this.isQuizMode = false;
        this.correctBand = null;
        this.quizActive = false;
        this.quizCount = 0;
        this.quizScore = 0;
        this.totalQuestions = 10;

        this.canvas = document.getElementById("canvas");
        this.ctx = this.canvas.getContext("2d");

        this.fileInput = document.getElementById("fileInput");
        this.playButton = document.getElementById("playButton");
        this.loopButton = document.getElementById("loopButton");
        this.quizButton = document.getElementById("quizButton");
        this.quizMessage = document.getElementById("quizMessage");
        this.progressBar = document.getElementById("progressBar");

        this.endButtons = document.getElementById("endButtons");
        this.replayQuizButton = document.getElementById("replayQuiz");
        this.newQuizButton = document.getElementById("newQuiz");

        this.fileInput.addEventListener("change", e => this.loadFile(e));
        this.playButton.addEventListener("click", () => this.togglePlay());
        this.loopButton.addEventListener("click", () => this.toggleLoop());
        this.quizButton.addEventListener("click", () => this.toggleQuiz());
        this.canvas.addEventListener("click", e => this.handleCanvasClick(e));
        this.replayQuizButton.addEventListener("click", () => this.startQuiz());
        this.newQuizButton.addEventListener("click", () => this.resetQuiz());

        this.draw();
      }

      async loadFile(event) {
        const file = event.target.files[0];
        if (!file) return;
        const arrayBuffer = await file.arrayBuffer();
        this.buffer = await this.audioContext.decodeAudioData(arrayBuffer);
      }

      createFilters() {
        this.filters = this.bands.map(band => {
          const filter = this.audioContext.createBiquadFilter();
          filter.type = "bandpass";
          filter.frequency.value = band.freq;
          filter.Q.value = 1;
          return filter;
        });
      }

      play() {
        if (!this.buffer) return;
        if (this.source) this.source.stop();

        this.source = this.audioContext.createBufferSource();
        this.source.buffer = this.buffer;
        this.source.loop = this.isLooping;

        this.createFilters();

        let node = this.source;
        if (this.isQuizMode && this.correctBand !== null) {
          node.connect(this.filters[this.correctBand]);
          this.filters[this.correctBand].connect(this.analyser);
          this.analyser.connect(this.audioContext.destination);
        } else {
          node.connect(this.analyser);
          this.analyser.connect(this.audioContext.destination);
        }

        this.source.start();
        this.isPlaying = true;
        this.playButton.textContent = "Pause";
      }

      stop() {
        if (this.source) this.source.stop();
        this.isPlaying = false;
        this.playButton.textContent = "Play";
      }

      togglePlay() {
        if (this.audioContext.state === "suspended") {
          this.audioContext.resume();
        }
        if (this.isPlaying) {
          this.stop();
        } else {
          this.play();
        }
      }

      toggleLoop() {
        this.isLooping = !this.isLooping;
        this.loopButton.textContent = this.isLooping ? "Loop: On" : "Loop: Off";
        if (this.source) this.source.loop = this.isLooping;
      }

      toggleQuiz() {
        this.isQuizMode = !this.isQuizMode;
        this.quizButton.textContent = this.isQuizMode ? "Quitter Quiz" : "Mode Quiz";
        this.quizMessage.textContent = "";
        this.progressBar.style.width = "0%";
        this.endButtons.style.display = "none";
        if (this.isQuizMode) {
          this.startQuiz();
        } else {
          this.resetQuiz();
        }
      }

      startQuiz() {
        this.endButtons.style.display = "none";
        this.quizActive = true;
        this.quizCount = 0;
        this.quizScore = 0;
        this.progressBar.style.width = "0%";
        this.nextQuestion();
      }

      resetQuiz() {
        this.stop();
        this.quizActive = false;
        this.correctBand = null;
        this.quizCount = 0;
        this.quizScore = 0;
        this.progressBar.style.width = "0%";
        this.quizMessage.textContent = "";
        this.endButtons.style.display = "none";
        if (this.isQuizMode) this.startQuiz();
      }

      nextQuestion() {
        if (this.quizCount >= this.totalQuestions) {
          this.endQuiz();
          return;
        }
        this.correctBand = Math.floor(Math.random() * this.bands.length);
        this.quizCount++;
        this.stop();
        this.play();
      }

      handleCanvasClick(event) {
        if (!this.isQuizMode || !this.quizActive) return;
        const rect = this.canvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const bandWidth = this.canvas.width / this.bands.length;
        const clickedBand = Math.floor(x / bandWidth);

        if (clickedBand === this.correctBand) {
          this.quizMessage.textContent = "Bonne réponse !";
          this.quizMessage.className = "correct";
          this.quizScore++;
        } else {
          this.quizMessage.textContent = `Mauvaise réponse... C'était "${this.bands[this.correctBand].name}"`;
          this.quizMessage.className = "wrong";
        }

        const progress = (this.quizCount / this.totalQuestions) * 100;
        this.progressBar.style.width = progress + "%";

        setTimeout(() => {
          this.quizMessage.textContent = "";
          this.correctBand = null;
          this.nextQuestion();
        }, 2000);
      }

      endQuiz() {
        this.quizActive = false;
        this.stop();
        this.quizMessage.textContent = `Quiz terminé ! Score : ${this.quizScore}/${this.totalQuestions}`;
        this.quizMessage.className = "";
        this.endButtons.style.display = "block";
      }

      draw() {
        requestAnimationFrame(() => this.draw());
        const bufferLength = this.analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        this.analyser.getByteFrequencyData(dataArray);

        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

        const barWidth = (this.canvas.width / bufferLength) * 2.5;
        let x = 0;
        for (let i = 0; i < bufferLength; i++) {
          const barHeight = dataArray[i] / 2;
          this.ctx.fillStyle = "rgb(" + (barHeight + 100) + ",50,50)";
          this.ctx.fillRect(x, this.canvas.height - barHeight, barWidth, barHeight);
          x += barWidth + 1;
        }

        if (this.isQuizMode && this.correctBand !== null) {
          const bandWidth = this.canvas.width / this.bands.length;
          this.ctx.fillStyle = "rgba(0,255,0,0.3)";
          this.ctx.fillRect(this.correctBand * bandWidth, 0, bandWidth, this.canvas.height);
        }
      }
    }

    const app = new AudioQuiz();
  </script>
</body>
</html>
