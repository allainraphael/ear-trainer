<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Ear Training</title>
<style>
body { background:#111; color:white; font-family:Arial; text-align:center; }
canvas { background:#000; width:90%; height:400px; margin-top:20px; border-radius:12px; cursor:pointer; }
button, select { margin:5px; padding:10px 20px; border:none; border-radius:8px; cursor:pointer; }
.active { background:#4facfe; color:white; }
#resultsTable { margin:20px auto; border-collapse:collapse; width:80%; max-width:700px; }
#resultsTable th, #resultsTable td { border:1px solid #555; padding:8px; }
#resultsTable th { background:#222; }
.correct { color:lime; font-weight:bold; }
.incorrect { color:red; font-weight:bold; }
#replayBtn, #newQuizBtn, #quitQuizBtn { display:none; margin-top:15px; background:#4caf50; color:white; }
#newQuizBtn { background:#2196F3; }
#quitQuizBtn { background:#f44336; }
#progressContainer { width:80%; max-width:600px; height:20px; background:#333; border-radius:10px; margin:15px auto; overflow:hidden; display:none; }
#progressBar { height:100%; width:0%; background:#4facfe; transition:width 0.5s ease; }
</style>
</head>
<body>
<h1>Ear Training</h1>

<input type="file" id="fileInput" accept="audio/*"><br>

<select id="sourceSelect">
  <option value="file" selected>🎵 Fichier audio</option>
  <option value="white">🌫️ Bruit blanc</option>
  <option value="pink">🌸 Bruit rose</option>
</select>

<br>
<select id="modeSelect">
  <option value="7" selected>7 bandes</option>
  <option value="10">10 bandes</option>
  <option value="15">15 bandes</option>
  <option value="31">31 bandes</option>
</select>

<button id="playBtn">▶️ Play/Pause</button>
<button id="loopBtn" class="active">🔁 Boucle ON</button>
<button id="resetBtn">♻️ Reset bande</button>
<button id="quizBtn">🎯 Quiz</button>
<br>
<label>Volume : <input type="range" id="volume" min="0" max="2" value="1" step="0.01"></label>

<div id="progressContainer">
  <div id="progressBar"></div>
</div>

<canvas id="analyser"></canvas>
<p id="quizMessage"></p>
<table id="resultsTable" style="display:none;">
  <thead>
    <tr>
      <th>#</th>
      <th>Ta réponse</th>
      <th>Bonne réponse</th>
      <th>Résultat</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<div>
  <button id="replayBtn">🔁 Rejouer la série</button>
  <button id="newQuizBtn">🆕 Nouveau quiz</button>
  <button id="quitQuizBtn">❌ Quitter quiz</button>
</div>

<script>
class AudioApp {
  constructor() {
    // DOM
    this.fileInput = document.getElementById("fileInput");
    this.sourceSelect = document.getElementById("sourceSelect");
    this.playBtn = document.getElementById("playBtn");
    this.loopBtn = document.getElementById("loopBtn");
    this.resetBtn = document.getElementById("resetBtn");
    this.quizBtn = document.getElementById("quizBtn");
    this.replayBtn = document.getElementById("replayBtn");
    this.newQuizBtn = document.getElementById("newQuizBtn");
    this.quitQuizBtn = document.getElementById("quitQuizBtn");
    this.volumeSlider = document.getElementById("volume");
    this.canvas = document.getElementById("analyser");
    this.ctx = this.canvas.getContext("2d");
    this.quizMessage = document.getElementById("quizMessage");
    this.resultsTable = document.getElementById("resultsTable");
    this.resultsBody = this.resultsTable.querySelector("tbody");
    this.progressContainer = document.getElementById("progressContainer");
    this.progressBar = document.getElementById("progressBar");
    this.modeSelect = document.getElementById("modeSelect");

    // audio
    this.audioContext = null;
    this.source = null;
    this.analyser = null;
    this.gainNode = null;
    this.filterNode = null;
    this.buffer = null;
    this.isPlaying = false;
    this.isLooping = true;
    this.startTime = 0;
    this.pauseTime = 0;

    // quiz
    this.currentBand = null;
    this.quizBand = null;
    this.highlightBand = null;
    this.highlightBandOpacity = 0.3;
    this.clignotementInterval = null;
    this.modeQuestion = false;
    this.modeReponse = false;
    this.quizActive = false;
    this.quizCount = 0;
    this.quizScore = 0;
    this.totalQuestions = 10;

    this.frequencyBands = {}; // défini dynamiquement

    this.bindEvents();
    this.resizeCanvas();
    window.addEventListener("resize",()=>this.resizeCanvas());
    this.canvas.addEventListener("click",(e)=>this.handleCanvasClick(e));
    this.animationId = null;

    this.updateBands();
  }

  bindEvents(){
    this.fileInput.addEventListener("change", e=>this.loadFile(e));
    this.sourceSelect.addEventListener("change", ()=>this.handleSourceChange());
    this.playBtn.addEventListener("click", ()=>this.togglePlay());
    this.loopBtn.addEventListener("click", ()=>this.toggleLoop());
    this.resetBtn.addEventListener("click", ()=>this.resetBand());
    this.quizBtn.addEventListener("click", ()=>this.startQuizSeries());
    this.replayBtn.addEventListener("click", ()=>this.startQuizSeries());
    this.newQuizBtn.addEventListener("click", ()=>this.startQuizSeries());
    this.quitQuizBtn.addEventListener("click", ()=>this.quitQuiz());
    this.volumeSlider.addEventListener("input", ()=>this.setVolume(this.volumeSlider.value));
    this.modeSelect.addEventListener("change", ()=>this.updateBands());
  }

  resizeCanvas(){
    this.canvas.width = this.canvas.offsetWidth;
    this.canvas.height = this.canvas.offsetHeight;
  }

  // --- bruit blanc & rose ---
  generateNoise(type){
    const sampleRate = this.audioContext.sampleRate;
    const duration = 3; // secondes
    const buffer = this.audioContext.createBuffer(1, sampleRate * duration, sampleRate);
    const data = buffer.getChannelData(0);

    if(type === "white"){
      for(let i=0;i<data.length;i++) data[i] = Math.random()*2-1;
    } else if(type === "pink"){
      let b0=0,b1=0,b2=0,b3=0,b4=0,b5=0,b6=0;
      for(let i=0;i<data.length;i++){
        const white = Math.random()*2-1;
        b0 = 0.99886*b0 + white*0.0555179;
        b1 = 0.99332*b1 + white*0.0750759;
        b2 = 0.96900*b2 + white*0.1538520;
        b3 = 0.86650*b3 + white*0.3104856;
        b4 = 0.55000*b4 + white*0.5329522;
        b5 = -0.7616*b5 - white*0.0168980;
        data[i] = b0+b1+b2+b3+b4+b5+b6+white*0.5362;
        data[i]*=0.11;
        b6 = white*0.115926;
      }
    }
    return buffer;
  }

  handleSourceChange(){
    const type = this.sourceSelect.value;
    if(type === "file"){
      this.buffer = null;
    } else {
      if(!this.audioContext) this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
      this.buffer = this.generateNoise(type);
      this.play(); // lance directement le bruit
    }
  }

  async loadFile(e){
    const file = e.target.files[0];
    if(!file) return;
    if(!this.audioContext) this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const arrayBuffer = await file.arrayBuffer();
    this.buffer = await this.audioContext.decodeAudioData(arrayBuffer);
    this.sourceSelect.value = "file";
    this.pauseTime = 0;
    this.play();
  }

  play(){
    if(!this.buffer) return;

    // si une source existe déjà, on l'arrête
    if(this.source){
      try { this.source.stop(); } catch(e){}
    }

    this.source = this.audioContext.createBufferSource();
    this.source.buffer = this.buffer;
    this.source.loop = this.isLooping;

    // pipeline audio
    if(!this.gainNode){
      this.gainNode = this.audioContext.createGain();
      this.filterNode = this.audioContext.createBiquadFilter();
      this.analyser = this.audioContext.createAnalyser();
      this.analyser.fftSize = 2048;
      this.filterNode.connect(this.gainNode);
      this.gainNode.connect(this.analyser);
      this.analyser.connect(this.audioContext.destination);
    }

    this.source.connect(this.filterNode);
    this.source.start(0, this.pauseTime);

    this.isPlaying = true;
    this.playBtn.textContent = "⏸️ Pause";
    this.animate();
  }

  pause(){
    if(this.source){
      try { this.source.stop(); } catch(e){}
    }
    this.isPlaying = false;
    this.playBtn.textContent = "▶️ Play";
  }

  togglePlay(){
    if(this.isPlaying){ this.pause(); }
    else { this.play(); }
  }

  toggleLoop(){
    this.isLooping = !this.isLooping;
    this.loopBtn.classList.toggle("active", this.isLooping);
    this.loopBtn.textContent = this.isLooping ? "🔁 Boucle ON" : "➡️ Lecture simple";
    if(this.source) this.source.loop = this.isLooping;
  }

  setVolume(v){
    if(this.gainNode) this.gainNode.gain.value = v;
  }

  // --- dessin FFT ---
  animate(){
    if(!this.isPlaying) return;
    requestAnimationFrame(()=>this.animate());
    if(!this.analyser) return;
    const bufferLength = this.analyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);
    this.analyser.getByteFrequencyData(dataArray);

    const w = this.canvas.width;
    const h = this.canvas.height;
    const barWidth = w / bufferLength;
    this.ctx.fillStyle = "#000";
    this.ctx.fillRect(0,0,w,h);

    for(let i=0;i<bufferLength;i++){
      const v = dataArray[i];
      const y = v/255*h;
      this.ctx.fillStyle = `rgb(${v},${255-v},128)`;
      this.ctx.fillRect(i*barWidth, h-y, barWidth, y);
    }
  }

  resetBand(){ this.currentBand=null; if(this.isPlaying) this.play(); }

  frequencyToX(freq,width){ const min=20,max=20000; const logMin=Math.log10(min), logMax=Math.log10(max); const ratio=(Math.log10(freq)-logMin)/(logMax-logMin); return ratio*width; }

  dbToY(db,height){ const maxDb=20; let minDb=-100; if(this.floatData){ let minVal=Math.min(...this.floatData); if(minVal>-100) minDb=Math.floor(minVal/10)*10; } const ratio=(db-minDb)/(maxDb-minDb); return height-(ratio*height); }

  drawSpectrum(){
    const ctx=this.ctx, width=this.canvas.width, height=this.canvas.height;
    ctx.fillStyle='#000';
    ctx.fillRect(0,0,width,height);

    if(this.modeQuestion){
      for(const key in this.frequencyBands){
        const band=this.frequencyBands[key];
        const x1=this.frequencyToX(band.low,width);
        const x2=this.frequencyToX(band.high,width);
        ctx.fillStyle=band.color.replace("0.5","0.2");
        ctx.fillRect(x1,0,x2-x1,height);
        ctx.fillStyle='#fff'; ctx.font='12px Arial'; ctx.textAlign='center';
        ctx.fillText(`${band.name}`,(x1+x2)/2,20);
        ctx.fillText(`${band.low}-${band.high} Hz`,(x1+x2)/2,35);
      }
      ctx.fillStyle="rgba(255,255,255,0.8)"; ctx.font="80px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle";
      ctx.fillText("?",width/2,height/2); return;
    }

   // repères dB
  [20,0,-20,-40,-60,-80,-100].forEach(db=>{
    ctx.fillStyle="#aaa";
    ctx.font="10px Arial";
    ctx.textAlign="right";
    ctx.fillText(db+" dB", width-2,this.dbToY(db,height)-2);
  });

  // --- bandes ---
  for(const key in this.frequencyBands){
    const band = this.frequencyBands[key];
    const x1 = this.frequencyToX(band.low,width);
    const x2 = this.frequencyToX(band.high,width);

    // bande principale
    ctx.fillStyle = (this.currentBand===key) ? band.color : band.color.replace("0.5","0.2");
    ctx.fillRect(x1,0,x2-x1,height);

   // clignotement blanc superposé
    if(this.highlightBand === key){
      ctx.fillStyle = `rgba(255,255,255,${this.highlightBandOpacity})`;
      ctx.fillRect(x1,0,x2-x1,height);
    }

    ctx.fillStyle='#fff';
    ctx.font='12px Arial';
    ctx.textAlign='center';
    ctx.fillText(`${band.name}`,(x1+x2)/2,20);
    ctx.fillText(`${band.low}-${band.high} Hz`,(x1+x2)/2,35);
  }

    // repères Hz
    [20,50,100,200,500,1000,2000,5000,10000,20000].forEach(freq=>{ctx.fillStyle="#aaa";ctx.font="10px Arial";ctx.textAlign="left";ctx.fillText((freq>=1000?(freq/1000)+"k":freq)+"Hz",this.frequencyToX(freq,width)+2,height-5);});

    if(this.analyser){ this.analyser.getFloatFrequencyData(this.floatData); ctx.beginPath(); ctx.strokeStyle='#4facfe'; ctx.lineWidth=2;
      for(let i=0;i<this.floatData.length;i++){ const freq=(i*this.audioContext.sampleRate/2)/this.floatData.length; if(freq<20||freq>20000) continue; const x=this.frequencyToX(freq,width); const y=this.dbToY(this.floatData[i],height); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);}
      ctx.stroke();
    }
  }

  handleSourceChange(){
  const type = this.sourceSelect.value;
  if(type === "file"){
    this.buffer = null; // on attend le fichier
  } else {
    if(!this.audioContext) this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
    this.buffer = this.generateNoise(type);
    this.play();
  }
}

  handleCanvasClick(e){
    const rect=this.canvas.getBoundingClientRect(), x=e.clientX-rect.left, width=this.canvas.width;
    for(const key in this.frequencyBands){
      const band=this.frequencyBands[key], x1=this.frequencyToX(band.low,width), x2=this.frequencyToX(band.high,width);
      if(x>=x1 && x<=x2){
        if(this.quizActive){
          this.checkQuizAnswer(key);
        } else {
          this.currentBand=key;
          this.play(key);
        }
        break;
      }
    }
  }

  // ===== QUIZ =====
  startQuizSeries(){
    if(!this.buffer) { alert("Charge un son avant !"); return; }
    this.quizScore=0;
    this.quizCount=0;
    this.resultsBody.innerHTML="";
    this.resultsTable.style.display="table";
    this.progressContainer.style.display="block";
    this.quizActive=true;
    this.quizMessage.textContent="Quiz en cours...";
    this.nextQuiz();
  }

  nextQuiz(){
    const keys=Object.keys(this.frequencyBands);
    this.quizBand=keys[Math.floor(Math.random()*keys.length)];
    this.currentBand=null;
    this.modeQuestion=true;
    this.play(this.quizBand);
    this.quizCount++;
    this.progressBar.style.width=((this.quizCount-1)/this.totalQuestions*100)+"%";
  }

  checkQuizAnswer(selectedKey){
  const correct = selectedKey === this.quizBand;
  this.currentBand = this.quizBand; // bande toujours allumée en dessous
  this.modeQuestion = false;

  if(correct){ 
    this.quizScore++; 
    this.quizMessage.textContent = "✅ Correct !"; 
  } else { 
    this.quizMessage.textContent = `❌ Incorrect ! C'était ${this.frequencyBands[this.quizBand].name}`; 
  }

  // ajouter ligne tableau
  const tr = document.createElement("tr");
  tr.innerHTML = `<td>${this.quizCount}</td><td>${this.frequencyBands[selectedKey].name}</td><td>${this.frequencyBands[this.quizBand].name}</td><td class="${correct?'correct':'incorrect'}">${correct?'✓':'✗'}</td>`;
  this.resultsBody.appendChild(tr);

  // --- CLIGNOTEMENT rapide ---
  if(this.clignotementInterval) clearInterval(this.clignotementInterval);

  const totalTime = 1500; // ms
  const blinks = 6; // nombre de clignotements complets
  const halfCycle = totalTime / (blinks * 2); // durée d'un demi-clignotement
  let visible = false;

  this.highlightBand = this.quizBand;
  this.highlightBandOpacity = 0.8;

  this.clignotementInterval = setInterval(()=>{
    visible = !visible;
    this.highlightBandOpacity = visible ? 0.8 : 0.2;
  }, halfCycle);

  // fin du clignotement
  setTimeout(()=>{
    clearInterval(this.clignotementInterval);
    this.highlightBandOpacity = 0.8; // laisse la bande allumée
    if(this.quizCount < this.totalQuestions) {
      this.nextQuiz();
    } else {
      // arrêter le son après la 10e question
      if(this.source) {
        try { this.source.stop(); } catch(e){}
        this.isPlaying = false;
      }
      this.endQuiz();
    }
  }, totalTime);
}

  endQuiz(){
    this.quizMessage.textContent=`Quiz terminé ! Score : ${this.quizScore}/${this.totalQuestions}`;
    this.progressBar.style.width="100%";
    this.replayBtn.style.display="inline-block";
    this.newQuizBtn.style.display="inline-block";
    this.quitQuizBtn.style.display="inline-block";
    this.quizActive=false;
  }

  quitQuiz(){
    this.quizActive=false;
    this.modeQuestion=false;
    this.modeReponse=false;
    this.highlightBand=null;
    this.quizMessage.textContent="";
    this.progressContainer.style.display="none";
    this.replayBtn.style.display="none";
    this.newQuizBtn.style.display="none";
    this.quitQuizBtn.style.display="none";
    this.resultsTable.style.display="none";
    this.currentBand=null;
    if(this.isPlaying) this.play();
  }
}

const app = new AudioApp();
</script>
</body>
</html>
