<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ear Training Tool - CNSMDP</title>
<style>
body { background: #fff; font-family: Arial, sans-serif; margin: 0; padding: 20px; }
.container { max-width: 1000px; margin: 0 auto; }
h1 { text-align: center; margin-bottom: 20px; }
#spectrumContainer { position: relative; background: #fff; height: 400px; border-radius: 10px; overflow: hidden; box-shadow: 0 0 10px rgba(0,0,0,0.2); }
canvas { width: 100%; height: 100%; display: block; }
.band-btn { position: absolute; bottom: 0; cursor: pointer; opacity: 0.3; color: #fff; border: none; font-weight: bold; border-radius: 3px; }
.band-btn.active { opacity: 0.7; }
.controls { margin-top: 10px; text-align: center; }
button { padding: 8px 15px; margin: 0 5px; font-size: 1em; cursor: pointer; }
input[type=file] { margin-bottom: 10px; }
.volume-control { margin-top: 10px; text-align:center; }
</style>
</head>
<body>
<div class="container">
<h1>Outil d'Ear Training - CNSMDP</h1>
<input type="file" id="audioFile" accept="audio/*">
<div id="spectrumContainer">
<canvas id="spectrum"></canvas>
</div>

<div class="controls">
<button id="playBtn">‚ñ∂Ô∏è Lecture</button>
<button id="pauseBtn">‚è∏Ô∏è Pause</button>
<button id="stopBtn">‚èπÔ∏è Stop</button>
<button id="loopBtn">üîÑ Boucle</button>
</div>

<div class="volume-control">
üîä Volume: <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.7">
<span id="volumeValue">70%</span>
</div>
</div>

<script>
const canvas = document.getElementById('spectrum');
const ctx = canvas.getContext('2d');
canvas.width = canvas.offsetWidth;
canvas.height = canvas.offsetHeight;

let audioCtx, buffer, source, gainNode, analyser;
let isPlaying=false, isLooping=false;
let currentBand = null;

// D√©finition des bandes
const bands = [
{ name:'Sub-Bass', low:20, high:60, color:'#ff0000' },
{ name:'Bass', low:60, high:250, color:'#ff8000' },
{ name:'Low-Mid', low:250, high:500, color:'#ffff00' },
{ name:'Mid', low:500, high:2000, color:'#00ff00' },
{ name:'High-Mid', low:2000, high:4000, color:'#00ffff' },
{ name:'Treble', low:4000, high:8000, color:'#0080ff' },
{ name:'High-Treble', low:8000, high:20000, color:'#8000ff' }
];

// Cr√©ation des boutons bande superpos√©s
const spectrumContainer = document.getElementById('spectrumContainer');
bands.forEach((b,i)=>{
    const btn = document.createElement('button');
    btn.classList.add('band-btn');
    btn.dataset.index=i;
    btn.textContent=b.name;
    spectrumContainer.appendChild(btn);
    btn.addEventListener('click',()=>{
        currentBand = currentBand===i?null:i;
        document.querySelectorAll('.band-btn').forEach((b2,j)=>{
            b2.classList.toggle('active', j===currentBand);
        });
        stop(); play();
    });
});

function updateBandButtons(){
    const width = canvas.offsetWidth;
    bands.forEach((b,i)=>{
        const x1 = freqToX(b.low); const x2 = freqToX(b.high);
        const btn = spectrumContainer.querySelectorAll('.band-btn')[i];
        btn.style.left = x1+'px';
        btn.style.width = (x2-x1)+'px';
        btn.style.height = '40px';
    });
}

function freqToX(f){ 
    const minLog=Math.log10(20), maxLog=Math.log10(20000);
    return (Math.log10(f)-minLog)/(maxLog-minLog)*canvas.offsetWidth;
}

function draw(){
    if(!analyser) return;
    requestAnimationFrame(draw);
    const data = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(data);

    // Fond blanc
    ctx.fillStyle = '#fff';
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // Dessiner spectre
    ctx.beginPath();
    ctx.lineWidth=2; ctx.strokeStyle='#000';
    const sampleRate = audioCtx.sampleRate;
    const nyquist = sampleRate/2;
    const len = data.length;
    for(let i=0;i<len;i++){
        const freq = i*nyquist/len;
        if(freq<20 || freq>20000) continue;
        const x = freqToX(freq);
        const amp = data[i]/255;
        const y = canvas.height - amp*canvas.height;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();

    // Dessiner bandes en transparence
    bands.forEach((b,i)=>{
        ctx.fillStyle = b.color+'55';
        const x1=freqToX(b.low), x2=freqToX(b.high);
        ctx.fillRect(x1,0,x2-x1,canvas.height);
    });

    // Dessiner graduations logarithmiques
    ctx.fillStyle='#000';
    ctx.font='12px Arial';
    ctx.textAlign='center';
    const logTicks = [20,50,100,200,500,1000,2000,5000,10000,20000];
    logTicks.forEach(f=>{
        const x=freqToX(f);
        ctx.fillRect(x,canvas.height-5,1,5);
        ctx.fillText(f, x, canvas.height-7);
    });

    updateBandButtons();
}

// Gestion fichier audio
document.getElementById('audioFile').addEventListener('change',async e=>{
    if(!e.target.files[0]) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const arrayBuffer = await e.target.files[0].arrayBuffer();
    buffer = await audioCtx.decodeAudioData(arrayBuffer);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize=2048;
    draw();
});

// Contr√¥les lecture
document.getElementById('playBtn').addEventListener('click',play);
document.getElementById('pauseBtn').addEventListener('click',stop);
document.getElementById('stopBtn').addEventListener('click',stop);
document.getElementById('loopBtn').addEventListener('click',()=>{
    isLooping = !isLooping;
    document.getElementById('loopBtn').textContent = isLooping?'üîÑ Boucle ON':'üîÑ Boucle';
});

// Volume
document.getElementById('volumeSlider').addEventListener('input',e=>{
    document.getElementById('volumeValue').textContent = Math.round(e.target.value*100)+'%';
    if(gainNode) gainNode.gain.value=e.target.value;
});

// Lecture audio
function play(){
    if(!buffer) return; stop();
    source = audioCtx.createBufferSource();
    source.buffer=buffer;
    source.loop=isLooping;

    gainNode=audioCtx.createGain();
    gainNode.gain.value=document.getElementById('volumeSlider').value;

    let lastNode = source;

    if(currentBand!==null){
        const b = bands[currentBand];
        const hp1=audioCtx.createBiquadFilter(); hp1.type='highpass'; hp1.frequency.value=b.low;
        const hp2=audioCtx.createBiquadFilter(); hp2.type='highpass'; hp2.frequency.value=b.low;
        const lp1=audioCtx.createBiquadFilter(); lp1.type='lowpass'; lp1.frequency.value=b.high;
        const lp2=audioCtx.createBiquadFilter(); lp2.type='lowpass'; lp2.frequency.value=b.high;
        lastNode.connect(hp1); hp1.connect(hp2); hp2.connect(lp1); lp1.connect(lp2);
        lastNode = lp2;
    }

    lastNode.connect(gainNode); gainNode.connect(analyser); analyser.connect(audioCtx.destination);
    source.start(); isPlaying=true;
}

// Stop audio
function stop(){ if(source){ source.stop(); source=null; isPlaying=false; }}
window.addEventListener('resize',()=>{ canvas.width=canvas.offsetWidth; canvas.height=canvas.offsetHeight; draw(); });
</script>
</body>
</html>
