<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Outil d'Ear Training - CNSMDP</title>
<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #fff;
        padding: 20px;
        color: #000;
    }
    h1 { text-align: center; margin-bottom: 20px; }
    .container { max-width: 900px; margin: auto; }
    #audioFile { display: none; }
    .file-label {
        display: inline-block;
        padding: 10px 20px;
        background: #007bff;
        color: #fff;
        cursor: pointer;
        border-radius: 25px;
        margin-bottom: 10px;
    }
    .controls { display: flex; justify-content: center; gap: 10px; margin: 10px 0; }
    .control-btn {
        padding: 8px 15px;
        border: 1px solid #ccc;
        background: #eee;
        cursor: pointer;
        border-radius: 5px;
    }
    .control-btn.active { background: #28a745; color: #fff; }
    #spectrum { width: 100%; height: 300px; background: #000; display: block; margin-top: 20px; }
</style>
</head>
<body>
<div class="container">
    <h1>Outil d'Ear Training</h1>
    <label for="audioFile" class="file-label">üìÅ Charger un fichier audio</label>
    <input type="file" id="audioFile" accept="audio/*">

    <div class="controls">
        <button class="control-btn" id="playBtn">‚ñ∂Ô∏è Lecture</button>
        <button class="control-btn" id="pauseBtn">‚è∏Ô∏è Pause</button>
        <button class="control-btn" id="stopBtn">‚èπÔ∏è Stop</button>
        <button class="control-btn active" id="loopBtn">üîÑ Boucle ON</button>
    </div>

    <canvas id="spectrum"></canvas>
</div>

<script>
class EarTrainingTool {
    constructor() {
        this.audioContext = null;
        this.audioBuffer = null;
        this.source = null;
        this.gainNode = null;
        this.filterNode = null;
        this.analyser = null;
        this.isPlaying = false;
        this.isLooping = true; // boucle activ√©e par d√©faut
        this.currentBand = null;
        this.animationFrame = null;
        this.canvas = document.getElementById('spectrum');
        this.ctx = this.canvas.getContext('2d');

        this.frequencyBands = {
            'sub-bass': { low: 20, high: 60, name: 'Sub-Bass', color: '#ff6b6b' },
            'bass': { low: 60, high: 250, name: 'Bass', color: '#ffa500' },
            'low-mid': { low: 250, high: 500, name: 'Low-Mid', color: '#ffff00' },
            'mid': { low: 500, high: 2000, name: 'Mid', color: '#00ff00' },
            'high-mid': { low: 2000, high: 4000, name: 'High-Mid', color: '#00ffff' },
            'treble': { low: 4000, high: 8000, name: 'Treble', color: '#0080ff' },
            'high-treble': { low: 8000, high: 20000, name: 'High-Treble', color: '#8000ff' }
        };

        this.setupCanvas();
        this.initializeEventListeners();
    }

    setupCanvas() {
        const canvas = this.canvas;
        canvas.width = canvas.offsetWidth * window.devicePixelRatio;
        canvas.height = canvas.offsetHeight * window.devicePixelRatio;
        this.ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
        canvas.addEventListener('click', (e) => this.handleCanvasClick(e));
    }

    initializeEventListeners() {
        document.getElementById('audioFile').addEventListener('change', (e) => this.loadAudioFile(e));
        document.getElementById('playBtn').addEventListener('click', () => this.play());
        document.getElementById('pauseBtn').addEventListener('click', () => this.pause());
        document.getElementById('stopBtn').addEventListener('click', () => this.stop());
        document.getElementById('loopBtn').addEventListener('click', () => this.toggleLoop());
    }

    async loadAudioFile(event) {
        const file = event.target.files[0];
        if (!file) return;
        try {
            this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const arrayBuffer = await file.arrayBuffer();
            this.audioBuffer = await this.audioContext.decodeAudioData(arrayBuffer);

            this.analyser = this.audioContext.createAnalyser();
            this.analyser.fftSize = 2048;

            this.startVisualization();
            this.play();
        } catch (e) {
            alert('Erreur de lecture du fichier audio');
        }
    }

    createBandpassFilter(lowFreq, highFreq) {
        const highpass = this.audioContext.createBiquadFilter();
        highpass.type = 'highpass';
        highpass.frequency.value = lowFreq;
        highpass.Q.value = 5; // pente plus raide

        const lowpass = this.audioContext.createBiquadFilter();
        lowpass.type = 'lowpass';
        lowpass.frequency.value = highFreq;
        lowpass.Q.value = 5;

        highpass.connect(lowpass);
        return { input: highpass, output: lowpass };
    }

    selectFrequencyBand(frequency) {
        this.currentBand = frequency;
        if(this.isPlaying) this.play();
    }

    toggleLoop() {
        this.isLooping = !this.isLooping;
        const btn = document.getElementById('loopBtn');
        btn.classList.toggle('active', this.isLooping);
        btn.textContent = this.isLooping ? 'üîÑ Boucle ON' : 'üîÑ Boucle OFF';
        if(this.isPlaying) this.play();
    }

    play() {
        if(!this.audioBuffer) return;
        this.stop();

        this.source = this.audioContext.createBufferSource();
        this.source.buffer = this.audioBuffer;
        this.source.loop = this.isLooping;

        this.gainNode = this.audioContext.createGain();
        this.gainNode.gain.value = 0.7;

        let outputNode = this.gainNode;
        if(this.currentBand) {
            const band = this.frequencyBands[this.currentBand];
            this.filterNode = this.createBandpassFilter(band.low, band.high);
            this.source.connect(this.filterNode.input);
            this.filterNode.output.connect(this.gainNode);
        } else {
            this.source.connect(this.gainNode);
        }

        this.gainNode.connect(this.analyser);
        this.analyser.connect(this.audioContext.destination);
        this.source.start(0);
        this.isPlaying = true;
    }

    pause() {
        if(this.source && this.isPlaying) {
            this.source.stop();
            this.isPlaying = false;
        }
    }

    stop() {
        if(this.source) {
            this.source.stop();
            this.source = null;
            this.isPlaying = false;
        }
    }

    handleCanvasClick(event) {
        const rect = this.canvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const width = this.canvas.offsetWidth;

        // Logarithmique
        const minLog = Math.log10(20);
        const maxLog = Math.log10(20000);
        const logFreq = minLog + ((x / width) * (maxLog - minLog));
        const frequency = Math.pow(10, logFreq);

        for(const key in this.frequencyBands) {
            const band = this.frequencyBands[key];
            if(frequency >= band.low && frequency <= band.high) {
                this.currentBand = key;
                if(this.isPlaying) this.play();
                break;
            }
        }
    }

    startVisualization() {
        const animate = () => {
            this.drawSpectrum();
            this.animationFrame = requestAnimationFrame(animate);
        };
        animate();
    }

    drawSpectrum() {
        const ctx = this.ctx;
        const width = this.canvas.offsetWidth;
        const height = this.canvas.offsetHeight;
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, width, height);

        if(!this.analyser) return;

        const bufferLength = this.analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        this.analyser.getByteFrequencyData(dataArray);

        // Dessiner bandes
        for(const key in this.frequencyBands) {
            const band = this.frequencyBands[key];
            const x1 = this.frequencyToX(band.low, width);
            const x2 = this.frequencyToX(band.high, width);
            ctx.fillStyle = (this.currentBand===key) ? band.color : band.color+'33';
            ctx.fillRect(x1, 0, x2-x1, height);

            if(this.currentBand===key){
                ctx.fillStyle='#fff';
                ctx.font='14px Arial';
                ctx.textAlign='center';
                ctx.fillText(band.name, (x1+x2)/2, 20);
                ctx.fillText(`${band.low}-${band.high}Hz`, (x1+x2)/2, 40);
            }
        }

        // Dessiner spectre
        const sampleRate = this.audioContext.sampleRate;
        const nyquist = sampleRate / 2;
        ctx.beginPath();
        ctx.strokeStyle = '#4facfe';
        ctx.lineWidth = 2;
        for(let i=0;i<bufferLength;i++){
            const freq = (i*nyquist)/bufferLength;
            if(freq<20 || freq>20000) continue;
            const x = this.frequencyToX(freq, width);
            const y = height - dataArray[i]*height/255;
            if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        }
        ctx.stroke();
    }

    frequencyToX(freq,width){
        const minLog=Math.log10(20);
        const maxLog=Math.log10(20000);
        const logFreq=Math.log10(freq);
        return ((logFreq-minLog)/(maxLog-minLog))*width;
    }
}

window.addEventListener('load',()=>{new EarTrainingTool();});
</script>
</body>
</html>
