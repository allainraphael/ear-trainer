<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Ear Training Tool - Bandes sur Spectre</title>
<style>
body { background:#222; color:#fff; font-family:Arial,sans-serif; text-align:center; margin:0; padding:20px;}
canvas { display:block; margin:auto; background:#000; border-radius:10px; }
.controls { margin-top:15px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap;}
.controls button { padding:10px 20px; border:none; border-radius:5px; background:linear-gradient(45deg,#4facfe,#00f2fe); color:#fff; cursor:pointer; font-size:1em;}
.controls button.active { background:linear-gradient(45deg,#ff6b6b,#ffd93d); color:#000;}
#volumeControl { margin-top:10px;}
</style>
</head>
<body>

<h1>Ear Training Tool</h1>
<input type="file" id="fileInput" accept="audio/*">
<canvas id="spectrum" width="900" height="300"></canvas>

<div class="controls">
    <button id="playBtn">‚ñ∂Ô∏è Lecture</button>
    <button id="pauseBtn">‚è∏Ô∏è Pause</button>
    <button id="stopBtn">‚èπÔ∏è Stop</button>
    <button id="loopBtn">üîÑ Boucle</button>
</div>

<div id="volumeControl">
üîä Volume: <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.7">
<span id="volumeValue">70%</span>
</div>

<script>
const canvas = document.getElementById('spectrum');
const ctx = canvas.getContext('2d');

let audioCtx = null;
let source = null;
let analyser = null;
let gainNode = null;
let buffer = null;
let isPlaying = false;
let isLooping = false;
let currentBand = null;

const bands = [
    {name:'Sub-Bass', low:20, high:60, color:'rgba(255,0,0,0.2)'},
    {name:'Bass', low:60, high:250, color:'rgba(255,165,0,0.2)'},
    {name:'Low-Mid', low:250, high:500, color:'rgba(255,255,0,0.2)'},
    {name:'Mid', low:500, high:2000, color:'rgba(0,255,0,0.2)'},
    {name:'High-Mid', low:2000, high:4000, color:'rgba(0,255,255,0.2)'},
    {name:'Treble', low:4000, high:8000, color:'rgba(0,0,255,0.2)'},
    {name:'High-Treble', low:8000, high:20000, color:'rgba(128,0,255,0.2)'}
];

function logX(freq){
    return Math.log10(freq/20)/Math.log10(20000/20)*canvas.width;
}

function setupAudio(){
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
    analyser.smoothingTimeConstant = 0.8;
}

document.getElementById('fileInput').addEventListener('change', async (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    setupAudio();
    const arrayBuffer = await file.arrayBuffer();
    buffer = await audioCtx.decodeAudioData(arrayBuffer);
    draw();
});

function play(){
    if(!buffer) return;
    stop();
    source = audioCtx.createBufferSource();
    source.buffer = buffer;
    source.loop = isLooping;

    gainNode = audioCtx.createGain();
    gainNode.gain.value = document.getElementById('volumeSlider').value;

    let lastNode = source;

    if(currentBand){
        const band = currentBand;
        const highpass = audioCtx.createBiquadFilter();
        highpass.type='highpass'; highpass.frequency.value = band.low;
        const lowpass = audioCtx.createBiquadFilter();
        lowpass.type='lowpass'; lowpass.frequency.value = band.high;
        lastNode.connect(highpass);
        highpass.connect(lowpass);
        lastNode = lowpass;
    }

    lastNode.connect(gainNode);
    gainNode.connect(analyser);
    analyser.connect(audioCtx.destination);
    source.start();
    isPlaying = true;
    draw();
}

function pause(){ stop(); }
function stop(){ if(source){ source.stop(); source=null; isPlaying=false; } }
function toggleLoop(){ isLooping = !isLooping; document.getElementById('loopBtn').classList.toggle('active',isLooping); if(source) source.loop=isLooping; }
function setVolume(val){ document.getElementById('volumeValue').textContent=Math.round(val*100)+'%'; if(gainNode) gainNode.gain.value=val; }

document.getElementById('playBtn').addEventListener('click',play);
document.getElementById('pauseBtn').addEventListener('click',pause);
document.getElementById('stopBtn').addEventListener('click',stop);
document.getElementById('loopBtn').addEventListener('click',toggleLoop);
document.getElementById('volumeSlider').addEventListener('input', e=>setVolume(e.target.value));

canvas.addEventListener('click', e=>{
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    currentBand = null;
    for(const b of bands){
        if(x>=logX(b.low) && x<=logX(b.high)){
            currentBand=b;
            break;
        }
    }
    play();
});

function draw(){
    if(!analyser) return;
    const data = new Uint8Array(analyser.frequencyBinCount);
    const height = canvas.height;
    const width = canvas.width;
    const nyquist = audioCtx.sampleRate/2;

    function loop(){
        if(!isPlaying) return;
        requestAnimationFrame(loop);
        analyser.getByteFrequencyData(data);

        ctx.clearRect(0,0,width,height);
        ctx.fillStyle='#000';
        ctx.fillRect(0,0,width,height);

        // Dessiner bandes transparentes
        bands.forEach(b=>{
            ctx.fillStyle = b.color;
            ctx.fillRect(logX(b.low),0,logX(b.high)-logX(b.low),height);
        });

        // Dessiner spectre
        ctx.beginPath();
        ctx.strokeStyle='#0f0';
        ctx.lineWidth=2;
        for(let i=0;i<data.length;i++){
            const freq = i*nyquist/data.length;
            if(freq<20 || freq>20000) continue;
            const x = logX(freq);
            const y = height - (data[i]/255)*height;
            if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        }
        ctx.stroke();

        // Dessiner labels fr√©quence
        ctx.fillStyle='#fff';
        ctx.font='10px Arial';
        [20,50,100,200,500,1000,2000,5000,10000,20000].forEach(f=>{
            const x = logX(f);
            ctx.fillText(f>=1000?f/1000+'k':f, x, 10);
        });
    }
    loop();
}
</script>
</body>
</html>
